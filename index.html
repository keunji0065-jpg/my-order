<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∞ïÏùÄÏßÄ Ï£ºÎ¨∏ÏÑú PRO (Final Complete)</title>
    
    <!-- Daum Postcode -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'],
                        mono: ['Pretendard', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f4f8', 100: '#d9e2ec', 200: '#bcccdc', 300: '#9fb3c8', 400: '#829ab1',
                            500: '#627d98', 600: '#486581', 700: '#334e68', 800: '#243b53', 900: '#102a43',
                        },
                        accent: {
                            rose: '#d64545', teal: '#3ebd93', amber: '#f0b429',
                        },
                        dark: {
                            bg: '#121212', card: '#1e1e1e', border: '#2c2c2c', input: '#252525'
                        }
                    },
                    boxShadow: {
                        'soft': '0 1px 3px 0 rgba(0, 0, 0, 0.05)',
                        'inner-soft': 'inset 0 1px 2px 0 rgba(0, 0, 0, 0.03)',
                    },
                    fontSize: { 'xxs': '0.65rem' },
                    animation: { spin: 'spin 1s linear infinite' }
                }
            }
        }
    </script>
    
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css");
        
        body { 
            font-family: 'NanumSquareNeo', sans-serif; 
            -webkit-font-smoothing: antialiased; 
            background-color: #f5f7fa;
        }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        *:focus { outline: none !important; }
        
        .grid-rows-compact { grid-template-columns: 40px 1.2fr 3fr 0.5fr 1fr 1.5fr 2fr 30px; }
    </style>
</head>
<body class="bg-[#f5f7fa] dark:bg-dark-bg text-slate-700 dark:text-gray-300 transition-colors duration-200 min-h-screen flex flex-col overflow-hidden">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- GLOBAL UTILITIES ---
        const sanitizeOrder = (order) => {
            if (!order || typeof order !== 'object') return null;
            const sanitized = {
                id: order.id || Date.now() + Math.random(),
                customer: order.customer || '',
                product: order.product || '',
                quantity: Number(order.quantity) || 1,
                price: Number(order.price) || 0,
                deposit: Number(order.deposit) || 0,
                cardAmount: Number(order.cardAmount) || 0,
                isPaid: !!order.isPaid,
                isCardPaid: !!order.isCardPaid,
                isShippingPaid: !!order.isShippingPaid,
                customShippingFee: order.customShippingFee === null ? null : (Number(order.customShippingFee) || 0),
                memo: order.memo || '',
                originalText: order.originalText || '',
                recipientName: order.recipientName || '',
                phone: order.phone || '', 
                zipCode: order.zipCode || '',
                addressText: order.addressText || '',
                shippingMemo: order.shippingMemo || '',
                isCRM: !!order.isCRM,
            };
            sanitized.isAddressFilled = !!sanitized.recipientName && !!sanitized.phone && !!sanitized.addressText;
            return sanitized;
        };

        const Icon = React.memo(({ name, size = 14, className = "", weight = "regular", spin = false }) => {
             const map = {
                ClipboardList: "ph-clipboard-text", FileDown: "ph-download-simple", Trash2: "ph-trash", Plus: "ph-plus",
                Search: "ph-magnifying-glass", Youtube: "ph-youtube-logo", CheckCircle: "ph-check-circle", 
                ShoppingCart: "ph-shopping-cart", DollarSign: "ph-currency-dollar", CreditCard: "ph-credit-card",
                Truck: "ph-truck", Copy: "ph-copy", X: "ph-x", Pencil: "ph-pencil-simple",
                Moon: "ph-moon", FloppyDisk: "ph-floppy-disk", Clock: "ph-clock-countdown", Money: "ph-money", Package: "ph-package",
                ArrowRight: "ph-arrow-right", UploadSimple: "ph-upload-simple", Note: "ph-note-pencil", MapPin: "ph-map-pin",
                Address: "ph-map-pin", User: "ph-user", Brain: "ph-brain", ChartBar: "ph-chart-bar", WarningCircle: "ph-warning-circle",
                Wallet: "ph-wallet", TrendUp: "ph-trend-up", Coins: "ph-coins", Bank: "ph-bank", Receipt: "ph-receipt",
                HandCoins: "ph-hand-coins", Calculator: "ph-calculator", Eraser: "ph-eraser", List: "ph-list",
                CaretDown: "ph-caret-down", FileXls: "ph-file-xls", Sun: "ph-sun", Lightning: "ph-lightning",
                Star: "ph-star", Users: "ph-users", AddressBook: "ph-address-book", CloudArrowUp: "ph-cloud-arrow-up", CloudArrowDown: "ph-cloud-arrow-down",
                Gear: "ph-gear", Spinner: "ph-spinner"
            };
            const weightClass = weight === 'bold' ? 'ph-bold' : (weight === 'fill' ? 'ph-fill' : 'ph');
            const spinClass = spin ? 'animate-spin' : '';
            return <i className={`${weightClass} ${map[name] || 'ph-question'} ${className} ${spinClass}`} style={{ fontSize: size }}></i>;
        });

        // --- COMPONENT: Compact Stat Card ---
        const CompactStat = ({ label, value, subValue, icon, colorClass }) => (
            <div className={`flex items-center justify-between p-2 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border shadow-soft rounded-md h-full`}>
                <div>
                    <p className="text-[9px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wider mb-0.5">{label}</p>
                    <div className="flex items-baseline gap-0.5">
                        <span className={`text-sm font-bold font-mono ${colorClass}`}>{value}</span>
                        {subValue && <span className="text-[9px] text-slate-400">{subValue}</span>}
                    </div>
                </div>
                <div className={`p-1 rounded-md bg-slate-50 dark:bg-dark-bg`}>
                    <Icon name={icon} size={14} className={colorClass} weight="fill"/>
                </div>
            </div>
        );

        // --- COMPONENT: Summary Section ---
        const SummarySection = React.memo(({ stats, handleUnpaidFilterClick, unpaidFilter }) => {
            return (
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 w-full">
                    <div className="col-span-2 bg-brand-700 dark:bg-brand-900 text-white p-2.5 rounded-md shadow-soft flex flex-col justify-center min-h-[56px]">
                        <div className="flex items-center gap-1.5 mb-0.5 opacity-90">
                            <Icon name="TrendUp" size={12} className="text-white"/>
                            <span className="text-[9px] font-bold uppercase tracking-widest">Ï¥ù ÏòàÏÉÅ Îß§Ï∂ú</span>
                        </div>
                        <div className="flex items-baseline gap-1">
                            <span className="text-lg font-bold font-mono tracking-tight">{stats.totalRev.toLocaleString()}</span>
                            <span className="text-[10px] opacity-70">Ïõê</span>
                        </div>
                    </div>
                    <CompactStat label="Ï¥ù Ï£ºÎ¨∏" value={stats.qty} subValue="Í∞ú" icon="Package" colorClass="text-slate-600 dark:text-slate-300" />
                    <CompactStat label="Î∞∞ÏÜ° ÏòàÏ†ï" value={stats.shippingCount} subValue="Í±¥" icon="Truck" colorClass="text-brand-600 dark:text-brand-400" />
                    <div className={`col-span-1 cursor-pointer transition-all ${unpaidFilter === 'cash' ? 'ring-1 ring-accent-rose' : 'hover:bg-slate-50'}`} onClick={() => handleUnpaidFilterClick('cash')}>
                        <CompactStat label="ÌòÑÍ∏à ÎØ∏ÏàòÍ∏à" value={stats.cashUnpaid.toLocaleString()} subValue="" icon="WarningCircle" colorClass="text-accent-rose" />
                    </div>
                    <div className={`col-span-1 cursor-pointer transition-all ${unpaidFilter === 'ship' ? 'ring-1 ring-accent-amber' : 'hover:bg-slate-50'}`} onClick={() => handleUnpaidFilterClick('ship')}>
                        <CompactStat label="Î∞∞ÏÜ° ÎØ∏ÏàòÍ∏à" value={stats.shipUnpaid.toLocaleString()} subValue="" icon="WarningCircle" colorClass="text-accent-amber" />
                    </div>
                </div>
            );
        });

        // --- COMPONENT: Inline Product Manager ---
        const InlineProductManager = ({ productHistory, setProductHistory, setOrders, showToast }) => {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');
            const handleSave = () => {
                if (!name.trim()) { showToast("ÏûÖÎ†• ÌïÑÏöî", "error"); return; }
                const cleanName = name.trim();
                const newUnitPrice = Number(price);
                const isUpdate = productHistory.hasOwnProperty(cleanName);
                setProductHistory(prev => ({ ...prev, [cleanName]: newUnitPrice }));
                setOrders(prev => prev.map(o => (o.product && o.product.trim() === cleanName) ? { ...o, price: o.quantity * newUnitPrice } : o));
                showToast(isUpdate ? "Îã®Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏" : "ÏÉÅÌíà Îì±Î°ù ÏôÑÎ£å");
                setName(''); setPrice('');
            };
            const handleDelete = (key) => { if(window.confirm('ÏÇ≠Ï†ú?')) setProductHistory(prev => { const n = {...prev}; delete n[key]; return n; }) };
            const handleItemClick = (n, p) => { setName(n); setPrice(p); };
            return (
                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-md p-2 flex flex-col h-full shadow-soft">
                    <div className="flex gap-1 mb-1.5">
                        <input className="flex-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm px-2 py-1 text-xs outline-none focus:border-brand-500 text-slate-700 dark:text-gray-200" placeholder="ÏÉÅÌíàÎ™Ö" value={name} onChange={e=>setName(e.target.value)} />
                        <input className="w-14 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm px-2 py-1 text-xs outline-none focus:border-brand-500 text-right text-slate-700 dark:text-gray-200 font-mono" type="number" placeholder="Îã®Í∞Ä" value={price} onChange={e=>setPrice(e.target.value)} />
                        <button onClick={handleSave} className="bg-brand-700 hover:bg-brand-800 text-white px-2 py-1 rounded-sm text-xs font-bold transition-colors">Ï†ÄÏû•</button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 dark:bg-dark-bg border border-slate-100 dark:border-dark-border rounded-sm p-0.5">
                        <ul className="space-y-px">
                            {Object.entries(productHistory).map(([n, p]) => (
                                <li key={n} onClick={() => handleItemClick(n, p)} className="flex justify-between items-center px-2 py-1 hover:bg-white hover:shadow-sm dark:hover:bg-dark-card cursor-pointer text-xs border border-transparent hover:border-slate-100 dark:hover:border-dark-border rounded-sm group transition-all">
                                    <span className="font-medium text-slate-600 dark:text-slate-300 truncate w-24">{n}</span>
                                    <div className="flex items-center gap-2">
                                        <span className="font-mono text-slate-400 dark:text-slate-500">{p.toLocaleString()}</span>
                                        <button onClick={(e)=>{e.stopPropagation(); handleDelete(n)}} className="text-slate-300 hover:text-accent-rose opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="X" size={10} /></button>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            );
        };

        const ActionButton = React.memo(({ onClick, color, icon, text, active, className, loading }) => {
            const base = "px-2 py-1 rounded-sm text-xs font-bold flex items-center gap-1 transition-all border shadow-sm h-7";
            const colors = {
                brand: "bg-brand-600 text-white border-brand-700 hover:bg-brand-700",
                white: "bg-white dark:bg-dark-card text-slate-600 dark:text-slate-300 border-slate-200 dark:border-dark-border hover:bg-slate-50 hover:text-brand-700",
                dark: "bg-brand-800 text-white border-brand-900 hover:bg-brand-900",
                ghost: "bg-transparent text-slate-500 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800",
            };
            return (
                <button onClick={onClick} disabled={loading} className={`${base} ${colors[color] || colors.white} ${active ? 'ring-1 ring-brand-500' : ''} ${className} ${loading ? 'opacity-70 cursor-wait' : ''}`}>
                    {loading ? <Icon name="Spinner" size={12} spin={true}/> : <Icon name={icon} size={12} weight="bold"/>} {text}
                </button>
            );
        });

        const ProductAutocomplete = ({ id, value, onChange, onSelect, onDeleteProduct, onKeyDown, priceMap }) => {
            const [show, setShow] = useState(false);
            const ref = useRef(null);
            useEffect(() => { const h = (e) => { if (ref.current && !ref.current.contains(e.target)) setShow(false); }; document.addEventListener("mousedown", h); return () => document.removeEventListener("mousedown", h); }, []);
            const filtered = Object.entries(priceMap).filter(([k]) => k.toLowerCase().includes(value.toLowerCase()));
            return (
                <div className="relative w-full" ref={ref}>
                    <input id={id} className="w-full bg-transparent outline-none text-xs font-bold text-slate-700 dark:text-slate-200 placeholder-slate-300 py-0.5" value={value} onChange={e => { onChange(e); setShow(true); }} onFocus={() => setShow(true)} onKeyDown={onKeyDown} placeholder="ÏÉÅÌíàÎ™Ö" autoComplete="off" />
                    {show && filtered.length > 0 && (
                        <ul className="absolute z-50 left-0 top-full mt-0.5 w-full bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border shadow-lg max-h-32 overflow-y-auto rounded-sm text-xs">
                            {filtered.map(([n, p]) => (
                                <li key={n} className="px-2 py-1.5 hover:bg-slate-50 dark:hover:bg-dark-input cursor-pointer flex justify-between border-b border-slate-50 dark:border-dark-border last:border-0 text-slate-700 dark:text-slate-300" onClick={() => { onSelect(n, p); setShow(false); }}>
                                    <span className="font-medium">{n}</span><span className="font-mono text-slate-400">{p.toLocaleString()}</span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        const App = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            const [rawInput, setRawInput] = useState('');
            const [globalMemo, setGlobalMemo] = useState(() => localStorage.getItem('globalMemo') || '');
            
            // Data Persistence
            const [productHistory, setProductHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('productHistory')) || {}; } catch { return {}; } });
            const [customerDB, setCustomerDB] = useState(() => { try { return JSON.parse(localStorage.getItem('customerDB')) || {}; } catch { return {}; } }); 
            const [orders, setOrders] = useState(() => { try { const stored = JSON.parse(localStorage.getItem('youtubeOrders')); if (Array.isArray(stored)) return stored.map(sanitizeOrder).filter(o => o !== null); return []; } catch { return []; } });
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('googleScriptUrl') || '');
            
            const [isProcessing, setIsProcessing] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [toast, setToast] = useState(null);
            const [pricePerUnit, setPricePerUnit] = useState('');
            const [shippingFee, setShippingFee] = useState(4000);
            const [defaultProductName, setDefaultProductName] = useState('');
            const [filterText, setFilterText] = useState('');
            const [editingAmountId, setEditingAmountId] = useState(null);
            const [editingAddressId, setEditingAddressId] = useState(null); 
            const [editingShippingId, setEditingShippingId] = useState(null); 
            const [unpaidFilter, setUnpaidFilter] = useState(null); 
            const [isExcelMenuOpen, setIsExcelMenuOpen] = useState(false);
            const ordersRef = useRef(orders);
            const fileInputRef = useRef(null);
            const customerFileRef = useRef(null);
            const excelMenuRef = useRef(null); 

            useEffect(() => { if (isDarkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }, [isDarkMode]);
            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); ordersRef.current = orders; }, [orders]);
            useEffect(() => { localStorage.setItem('globalMemo', globalMemo); }, [globalMemo]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);
            useEffect(() => { localStorage.setItem('customerDB', JSON.stringify(customerDB)); }, [customerDB]);
            useEffect(() => { localStorage.setItem('googleScriptUrl', googleScriptUrl); }, [googleScriptUrl]);
            useEffect(() => { const handleClickOutside = (event) => { if (excelMenuRef.current && !excelMenuRef.current.contains(event.target)) { setIsExcelMenuOpen(false); } }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, []);

            const getCSVString = (listData, mode) => { const list = [...listData].map(sanitizeOrder).sort((a, b) => (a.customer || '').localeCompare(b.customer || '')); const firstIds = {}; list.forEach(o => { if (o.customer && !firstIds[o.customer]) firstIds[o.customer] = o.id; }); const clean = (val) => '"' + String(val || '').replace(/"/g, '""') + '"'; const cleanPhone = (val) => { if (!val) return '""'; const strVal = String(val); return '"\u200B' + strVal + '"'; }; if (mode === 'invoice') { const excelHeaders = ['', '', '', '', 'ÏÉÅÌíàÎ™Ö', 'ÏàòÎ†πÏù∏', 'Ïó∞ÎùΩÏ≤ò', 'Ï£ºÏÜå', 'Î∞∞ÏÜ°Î©îÎ™®', '', 'Î©îÎ™®', 'Ïö∞Ìé∏Î≤àÌò∏', '']; const csv = [excelHeaders.join(',')].concat(list.map(o => { let quantitySuffix = ''; if (o.quantity >= 2) { quantitySuffix = ` ‚òÖ${o.quantity}`; } const productName = `[${o.customer || 'ÎØ∏ÏßÄÏ†ï'}] ${o.product}${quantitySuffix}`; return ['', '', '', '', clean(productName), clean(o.recipientName), cleanPhone(o.phone), clean(o.addressText), clean(o.shippingMemo), '', clean(o.memo), cleanPhone(o.zipCode), ''].join(','); })).join('\n'); return "\ufeff" + csv; } else { const headers = ['ÎãâÎÑ§ÏûÑ', 'ÏûÖÍ∏àÎ™Ö', 'ÏÉÅÌíàÎ™Ö', 'ÏàòÎüâ', 'Í∏àÏï°', 'ÏûÖÍ∏àÏï°(ÌòÑÍ∏à)', 'Ïπ¥ÎìúÍ≤∞Ï†úÏï°', 'Î∞∞ÏÜ°ÎπÑ', 'ÎØ∏ÏàòÍ∏à', 'ÏàòÎ†πÏù∏', 'Ïó∞ÎùΩÏ≤ò', 'Ïö∞Ìé∏Î≤àÌò∏', 'Ï£ºÏÜå', 'Î∞∞ÏÜ°Î©îÎ™®', 'Î©îÎ™®']; const csv = [headers.join(',')].concat(list.map(o => { const isFirst = firstIds[o.customer] === o.id; const ship = o.customShippingFee ?? shippingFee; const shipCharge = isFirst ? ship : 0; const unpaid = Math.max(0, (o.price + shipCharge) - (o.deposit + o.cardAmount + (isFirst && o.isShippingPaid ? ship : 0))); return [clean(o.customer), clean(o.phone), clean(o.product), o.quantity, o.price, clean(o.deposit), clean(o.cardAmount), clean(shipCharge), clean(unpaid), clean(o.recipientName), cleanPhone(o.phone), cleanPhone(o.zipCode), clean(o.addressText), clean(o.shippingMemo), clean(o.memo)].join(','); })).join('\n'); return "\ufeff" + csv; } };
            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 2500); };
            
            // --- CLOUD SYNC FUNCTIONS ---
            const handleSetGoogleUrl = () => {
                const url = window.prompt("Google Apps Script Ïõπ Ïï± URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\n(Î∞∞Ìè¨ ÌõÑ 'Ïõπ Ïï± URL' Î≥µÏÇ¨ Î∂ôÏó¨ÎÑ£Í∏∞)", googleScriptUrl);
                if (url !== null) {
                    setGoogleScriptUrl(url.trim());
                    showToast("URLÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
                }
            };
            
            const handleLoadFromGoogle = async () => {
                if (!googleScriptUrl) { handleSetGoogleUrl(); return; }
                setIsSyncing(true);
                try {
                    const res = await fetch(googleScriptUrl);
                    const data = await res.json();
                    if (data.orders) {
                        const rows = JSON.parse(data.orders);
                        const headers = rows[0];
                        const loadedOrders = rows.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((h, i) => obj[h] = row[i]);
                            return sanitizeOrder(obj);
                        });
                        setOrders(loadedOrders);
                    }
                    if (data.products) setProductHistory(JSON.parse(data.products));
                    if (data.customers) {
                        const custRows = JSON.parse(data.customers);
                        const newDB = {};
                        custRows.slice(1).forEach(r => {
                            newDB[r[0]] = { recipientName: r[1], phone: r[2], zipCode: r[3], addressText: r[4], shippingMemo: r[5] };
                        });
                        setCustomerDB(newDB);
                    }
                    showToast("Íµ¨Í∏Ä ÏãúÌä∏ÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.");
                } catch (e) {
                    showToast("Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: " + e.message, "error");
                } finally {
                    setIsSyncing(false);
                }
            };

            const handleSaveToGoogle = async () => {
                if (!googleScriptUrl) { handleSetGoogleUrl(); return; }
                setIsSyncing(true);
                try {
                    const payload = {
                        orders: JSON.stringify(orders),
                        products: JSON.stringify(productHistory),
                        customers: JSON.stringify(customerDB)
                    };
                    const res = await fetch(googleScriptUrl, { method: 'POST', body: JSON.stringify(payload) });
                    const json = await res.json();
                    if (json.status === 'success') showToast("Íµ¨Í∏Ä ÏãúÌä∏Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
                    else throw new Error(json.message || "Unknown Error");
                } catch (e) {
                    showToast("Ï†ÄÏû• Ïã§Ìå® (URL ÌôïÏù∏ ÌïÑÏöî)", "error");
                    console.error(e);
                } finally {
                    setIsSyncing(false);
                }
            };

            const handleDownloadHTML = () => { const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date(); const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}`; a.download = `Í∞ïÏùÄÏßÄ_Ï£ºÎ¨∏ÏÑú_Î∞±ÏóÖ_${timestamp}.html`; a.click(); URL.revokeObjectURL(url); showToast('Ïï± ÌååÏùºÏù¥ ÏïàÏ†ÑÌïòÍ≤å Î∞±ÏóÖ(Ï†ÄÏû•)ÎêòÏóàÏäµÎãàÎã§!'); };
            const handleUploadClick = () => fileInputRef.current && fileInputRef.current.click();
            
            const handleFileUpload = (e) => { 
                const file = e.target.files[0]; 
                if (!file) return; 
                Papa.parse(file, { 
                    header: true, 
                    skipEmptyLines: true, 
                    complete: (results) => { 
                        const uploaded = results.data.map((row, i) => sanitizeOrder({ 
                            id: Date.now() + i, 
                            originalText: `UPLOAD: ${row['ÏÉÅÌíàÎ™Ö']}`, 
                            customer: row['ÎãâÎÑ§ÏûÑ']?.trim(), 
                            product: row['ÏÉÅÌíàÎ™Ö'], 
                            quantity: Number(row['ÏàòÎüâ']) || 1, 
                            price: Number(row['Í∏àÏï°']?.replace(/,/g, '')) || 0, 
                            deposit: Number(row['ÏûÖÍ∏àÏï°(ÌòÑÍ∏à)']), 
                            cardAmount: Number(row['Ïπ¥ÎìúÍ≤∞Ï†úÏï°']), 
                            recipientName: row['ÏàòÎ†πÏù∏'], 
                            phone: row['Ïó∞ÎùΩÏ≤ò'], 
                            zipCode: row['Ïö∞Ìé∏Î≤àÌò∏'], 
                            addressText: row['Ï£ºÏÜå'], 
                            shippingMemo: row['Î∞∞ÏÜ°Î©îÎ™®'], 
                            memo: row['Î©îÎ™®'] 
                        })).filter(o => o.customer); 
                        setOrders(prev => [...uploaded, ...prev]); 
                        showToast(`${uploaded.length}Í±¥ ÏóÖÎ°úÎìú ÏôÑÎ£å!`); 
                    }
                }); 
                e.target.value = null; 
            };
            
            const handleCustomerUploadClick = () => customerFileRef.current && customerFileRef.current.click();
            const handleCustomerFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const newDB = { ...customerDB }; let count = 0; results.data.forEach(row => { const nick = row['ÎãâÎÑ§ÏûÑ'] || row['Nickname'] || row['Ïù¥Î¶Ñ'] || row['ÏÑ±Ìï®']; if (nick && nick.trim()) { newDB[nick.trim()] = { recipientName: row['ÏàòÎ†πÏù∏'] || row['Î∞õÎäîÎ∂Ñ'] || row['Ïù¥Î¶Ñ'] || nick.trim(), phone: row['Ïó∞ÎùΩÏ≤ò'] || row['Ï†ÑÌôîÎ≤àÌò∏'] || row['Ìú¥ÎåÄÌè∞'] || '', zipCode: row['Ïö∞Ìé∏Î≤àÌò∏'] || row['Zip'] || '', addressText: row['Ï£ºÏÜå'] || row['Address'] || row['Í∏∞Î≥∏Ï£ºÏÜå'] || '', shippingMemo: row['Î∞∞ÏÜ°Î©îÎ™®'] || row['Î∞∞ÏÜ°ÏöîÏ≤≠ÏÇ¨Ìï≠'] || row['Î©îÎ™®'] || '' }; count++; } }); setCustomerDB(newDB); showToast(`Ï¥ù ${count}Î™ÖÏùò Í≥†Í∞ù Ï†ïÎ≥¥Î•º Îì±Î°ùÌñàÏäµÎãàÎã§!`, 'success'); } }); e.target.value = null; };
            const getNicknameColor = (name) => { if (!name) return 'text-slate-700 dark:text-slate-300'; const colors = ['text-brand-600 dark:text-brand-400', 'text-slate-700 dark:text-slate-300']; let hash = 0; for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash); return colors[Math.abs(hash) % colors.length]; };
            const handleCopyMemo = () => { if (!globalMemo) { showToast('Î≥µÏÇ¨Ìï† Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error'); return; } const ta = document.createElement("textarea"); ta.value = globalMemo; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('Î©îÎ™® Î≥µÏÇ¨ ÏôÑÎ£å'); };
            const handleCopyResults = () => { if (filteredOrders.length === 0) return; let text = ''; const grouped = filteredOrders.reduce((acc, o) => { (acc[o.customer] = acc[o.customer] || []).push(o); return acc; }, {}); Object.entries(grouped).forEach(([name, items]) => { text += `üíô ${name} Îãò üíô\n\n`; items.forEach(o => { const qtyText = o.quantity > 1 ? ` (${o.quantity})` : ''; text += `${o.product}${qtyText} ${o.price.toLocaleString()}\n` }); const shipFee = items[0].customShippingFee ?? shippingFee; if (shipFee > 0) text += `Î∞∞ÏÜ°ÎπÑ ${shipFee.toLocaleString()}\n`; text += `-\n`; const cardTotal = items.reduce((s, o) => s + o.cardAmount, 0); const depositTotal = items.reduce((s, o) => s + o.deposit, 0); const itemTotal = items.reduce((s, o) => s + o.price, 0); const paidTotal = depositTotal + cardTotal; const totalRequired = itemTotal + shipFee; const isShipPaid = items.some(o => o.isShippingPaid); if (cardTotal > 0) { const cardFee = Math.round(cardTotal * 0.10); const totalCardPayment = cardTotal + cardFee; text += `ÏûÖÍ∏à ${depositTotal.toLocaleString()}\n`; text += `Ïπ¥Îìú ${cardTotal.toLocaleString()}\n`; text += `Ï¥ù Ïπ¥ÎìúÍ≤∞Ï†ú (10%) \n${totalCardPayment.toLocaleString()} ÏòàÏ†ï\n`; } else if (depositTotal > 0) { const displayDepositTotal = isShipPaid ? (depositTotal + shipFee) : depositTotal; text += `ÏûÖÍ∏à ${displayDepositTotal.toLocaleString()}\n`; } text += `¬†-\n`; const shippingCredit = isShipPaid ? shipFee : 0; const totalUnpaid = Math.max(0, totalRequired - paidTotal - shippingCredit); if (totalUnpaid > 0) { text += `ÎØ∏ÏûÖÍ∏à: ${totalUnpaid.toLocaleString()}Ïõê\n\n`; text += `Ïπ¥Ïπ¥Ïò§Î±ÖÌÅ¨ ÍπÄÏÑ†Ï†ï\n7942 18 01611 \n\nÏûÖÍ∏à Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§ üôè\n\n`; } else { text += `ÏôÑÎÇ© ÌôïÏù∏! Í∞êÏÇ¨Ìï©ÎãàÎã§ üòç\n\n`; } }); const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î≥µÏÇ¨ ÏôÑÎ£å'); };
            const firstOrderIds = useMemo(() => { const ids = {}; orders.forEach(o => { if (o.customer && !ids[o.customer]) ids[o.customer] = o.id; }); return ids; }, [orders]);
            const customerCounts = useMemo(() => orders.reduce((acc, o) => { if(o.customer) acc[o.customer] = (acc[o.customer] || 0) + 1; return acc; }, {}), [orders]);
            const filteredOrders = useMemo(() => { let result = orders; if (filterText) { const lower = filterText.toLowerCase(); result = result.filter(o => (o.customer && o.customer.toLowerCase().includes(lower)) || (o.product && o.product.toLowerCase().includes(lower))); } if (unpaidFilter) { const grouped = orders.reduce((acc, o) => { const k = o.customer || 'u'; if(!acc[k]) acc[k] = {p:0, d:0, c:0, ship:false, fee:null}; acc[k].p += o.price; acc[k].d += o.deposit; acc[k].c += o.cardAmount; if(o.isShippingPaid) acc[k].ship = true; if(o.customShippingFee !== null) acc[k].fee = o.customShippingFee; return acc; }, {}); result = result.filter(o => { const g = grouped[o.customer || 'u']; if (!g) return false; const ship = g.fee ?? shippingFee; const totalRequired = g.p + ship; const totalPaid = g.d + g.c; const shippingCredit = g.ship ? ship : 0; const personUnpaid = Math.max(0, totalRequired - totalPaid - shippingCredit); if (unpaidFilter === 'ship') { return !g.ship && ship > 0; } if (unpaidFilter === 'cash') { let cashUnpaid = 0; if (g.ship) { cashUnpaid = personUnpaid; } else { const unpaidAttribToShip = Math.min(personUnpaid, ship); cashUnpaid = personUnpaid - unpaidAttribToShip; } return cashUnpaid > 0; } return true; }); } return result; }, [orders, filterText, unpaidFilter, shippingFee]);
            const stats = useMemo(() => { const res = { qty: 0, orderCount: 0, shippingCount: 0, cardRev: 0, cashRev: 0, shipRev: 0, totalRev: 0, cardUnpaid: 0, cashUnpaid: 0, shipUnpaid: 0, totalUnpaid: 0 }; const grouped = filteredOrders.reduce((acc, o) => { const k = o.customer || 'u'; if(!acc[k]) acc[k] = {p:0, d:0, c:0, ship:false, fee:null, q:0}; acc[k].p += o.price; acc[k].d += o.deposit; acc[k].c += o.cardAmount; acc[k].q += o.quantity; if(o.isShippingPaid) acc[k].ship = true; if(o.customShippingFee !== null) acc[k].fee = o.customShippingFee; return acc; }, {}); Object.values(grouped).forEach(g => { const ship = g.fee ?? shippingFee; res.orderCount++; res.shippingCount++; res.cardRev += g.c; res.cashRev += Math.max(0, g.p - g.c); res.shipRev += ship; res.totalRev += (g.p + ship); res.qty += g.q; const totalRequired = g.p + ship; const totalPaid = g.d + g.c; const shippingCredit = g.ship ? ship : 0; const personUnpaid = Math.max(0, totalRequired - totalPaid - shippingCredit); if (g.ship) { res.cashUnpaid += personUnpaid; } else { const unpaidAttribToShip = Math.min(personUnpaid, ship); res.shipUnpaid += unpaidAttribToShip; res.cashUnpaid += (personUnpaid - unpaidAttribToShip); } res.totalUnpaid += personUnpaid; }); return res; }, [filteredOrders, shippingFee]);
            const filteredStats = useMemo(() => { return stats; }, [stats]);
            const handleToggleAmountEdit = (id) => { setEditingAmountId(id === editingAmountId ? null : id); setEditingShippingId(null); };
            const handleToggleShippingEdit = (id) => { setEditingShippingId(id === editingShippingId ? null : id); setEditingAmountId(null); };
            const handleToggleAddressEdit = (id) => { setEditingAddressId(id === editingAddressId ? null : id); };
            const handleKeyDown = (e, index, field) => { if (e.key === 'Enter') { e.preventDefault(); const nextIndex = index + 1; if (nextIndex < filteredOrders.length) { const nextElement = document.getElementById(`${field}-${nextIndex}`); if (nextElement) { nextElement.focus(); if (nextElement.select) nextElement.select(); } } } };
            const handleMemoKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); const textarea = e.target; const start = textarea.selectionStart; const end = textarea.selectionEnd; const value = globalMemo; const newValue = value.substring(0, start) + "\n‚ñ´ " + value.substring(end); setGlobalMemo(newValue); setTimeout(() => { textarea.selectionStart = textarea.selectionEnd = start + 3; }, 0); } };
            
            // --- PARSE ORDERS ---
            const handleParseOrders = () => {
                if (!rawInput.trim()) { showToast('ÏûÖÎ†• ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.', 'error'); return; }
                setIsProcessing(true);
                setTimeout(() => {
                    const blocks = rawInput.split(/\n\s*\n/).filter(block => block.trim() !== '');
                    const newOrders = blocks.map((block, i) => {
                        const lines = block.trim().split('\n').map(l => l.trim()).filter(l => l);
                        if (lines.length === 0) return null;
                        let rawCustomer = lines[0].replace(/@/g, '').trim();
                        let customer = rawCustomer.replace(/-[a-zA-Z0-9]+$/, '').trim();
                        let product = lines.slice(1).join(' ').trim() || defaultProductName;
                        let quantity = 1;
                        let unitPrice = productHistory[product] || Number(pricePerUnit) || 0;
                        const price = quantity * unitPrice;
                        const existingOrder = orders.find(o => o.customer === customer);
                        
                        // CRM Lookup
                        let recipientName = '', zipCode = '', addressText = '', shippingMemo = '', phone = '', isCRM = false;
                        const crmData = customerDB[customer];
                        if (crmData) {
                            recipientName = crmData.recipientName;
                            phone = crmData.phone;
                            zipCode = crmData.zipCode;
                            addressText = crmData.addressText;
                            shippingMemo = crmData.shippingMemo;
                            isCRM = true;
                        } else if (existingOrder) {
                            recipientName = existingOrder.recipientName;
                            phone = existingOrder.phone;
                            zipCode = existingOrder.zipCode;
                            addressText = existingOrder.addressText;
                            shippingMemo = existingOrder.shippingMemo;
                        }

                        return sanitizeOrder({ id: Date.now() + i + Math.random(), originalText: block, customer, product, quantity, price, phone, deposit: 0, isPaid: false, isShippingPaid: false, isCardPaid: false, cardAmount: 0, customShippingFee: null, memo: '', recipientName, zipCode, addressText, shippingMemo, isCRM });
                    }).filter(o => o !== null);
                    
                    setOrders(prev => [...newOrders, ...prev]);
                    setRawInput('');
                    setIsProcessing(false);
                    showToast(`${newOrders.length}Í±¥ Ï∂îÍ∞Ä (Îã®Í≥® ${newOrders.filter(o=>o.isCRM).length}Î™Ö ÏûêÎèôÏûÖÎ†•)`);
                }, 100);
            };

            const handleAddEmptyOrder = () => { setOrders(prev => [sanitizeOrder({ id: Date.now(), customer: '', product: defaultProductName, quantity: 1, price: Number(pricePerUnit) || 0 }), ...prev]); };
            const handleUpdateOrder = (id, field, value) => { setOrders(prev => prev.map(o => { if (o.id !== id) return o; let updates = { [field]: value }; if (field === 'quantity') { const savedUnitPrice = productHistory[o.product] || Number(pricePerUnit) || 0; updates.price = value * savedUnitPrice; } if (field === 'product') { const savedUnitPrice = productHistory[value]; if (savedUnitPrice !== undefined) { updates.price = o.quantity * savedUnitPrice; } } if (field === 'price') { if (o.product && o.quantity > 0) { const unitPrice = value / o.quantity; setProductHistory(prevHist => ({ ...prevHist, [o.product]: unitPrice })); } } const newPrice = updates.price ?? o.price; if (field === 'deposit') { const rem = Math.max(0, newPrice - value); updates.cardAmount = rem; updates.isCardPaid = rem > 0; } return sanitizeOrder({ ...o, ...updates }); })); };
            const handleProductSelect = (id, product, unitPrice) => { setOrders(prev => prev.map(o => { if (o.id !== id) return o; return sanitizeOrder({ ...o, product: product, price: o.quantity * unitPrice }); })); };
            const handleDeleteProduct = useCallback((productName) => { if (window.confirm(`'${productName}' ÏÉÅÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) { setProductHistory(prev => { const newHistory = { ...prev }; delete newHistory[productName]; return newHistory; }); showToast(`'${productName}' ÏÇ≠Ï†ú ÏôÑÎ£å`); } }, []);
            
            // --- UPDATED CRM UPDATE LOGIC ---
            const handleUpdateOrderBatch = (id, updates) => {
                setOrders(prev => {
                    const targetOrder = prev.find(o => o.id === id);
                    if (!targetOrder || !targetOrder.customer) return prev;
                    
                    const isAddressUpdate = ['recipientName', 'phone', 'zipCode', 'addressText', 'shippingMemo'].some(key => key in updates);
                    const targetCustomer = targetOrder.customer.trim();
                    
                    // CRM: Auto-save to DB if address info is updated
                    if (isAddressUpdate) {
                        const mergedOrder = { ...targetOrder, ...updates };
                        if (mergedOrder.recipientName && mergedOrder.addressText) {
                            setCustomerDB(prevDB => ({
                                ...prevDB,
                                [targetCustomer]: {
                                    recipientName: mergedOrder.recipientName,
                                    phone: mergedOrder.phone,
                                    zipCode: mergedOrder.zipCode,
                                    addressText: mergedOrder.addressText,
                                    shippingMemo: mergedOrder.shippingMemo
                                }
                            }));
                        }
                    }

                    return prev.map(o => {
                        if (o.id === id) return sanitizeOrder({ ...o, ...updates });
                        if (isAddressUpdate && o.customer && o.customer.trim() === targetCustomer) return sanitizeOrder({ ...o, ...updates, isCRM: true });
                        return o;
                    });
                });
            };

            const handleDelete = (id) => setOrders(prev => prev.filter(o => o.id !== id));
            const handleAutoDepositFull = (id) => { setOrders(prev => { return prev.map(o => { if (o.id === id) { if (o.isPaid) { return sanitizeOrder({ ...o, deposit: 0, cardAmount: 0, isPaid: false, isCardPaid: false }); } else { return sanitizeOrder({ ...o, deposit: o.price, cardAmount: 0, isPaid: true, isCardPaid: false }); } } return o; }); }); setEditingAmountId(null); setEditingShippingId(null); };
            const handleAutoCardFull = (id) => { setOrders(prev => prev.map(o => o.id === id ? sanitizeOrder({ ...o, deposit: 0, cardAmount: o.price, isPaid: true, isCardPaid: true }) : o)); setEditingAmountId(null); setEditingShippingId(null); };
            const handleUnpaidFilterClick = (type) => { if (unpaidFilter === type) { setUnpaidFilter(null); } else { setUnpaidFilter(type); } };
            const handleReset = () => { if (window.confirm("Ï†ïÎßêÎ°ú Î™®Îì† Ï£ºÎ¨∏ ÎÇ¥Ïó≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Í≥†Í∞ù Îç∞Ïù¥ÌÑ∞Îäî Ïú†ÏßÄÎê©ÎãàÎã§)")) { setOrders([]); showToast("Ï¥àÍ∏∞Ìôî ÏôÑÎ£å", "error"); } };

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-700 dark:text-gray-300">
                    {/* Header */}
                    <header className="h-10 bg-white dark:bg-dark-card border-b border-slate-200 dark:border-dark-border flex items-center justify-between px-3 shrink-0 shadow-sm z-50">
                        <div className="flex items-center gap-2">
                            <div className="bg-brand-700 text-white p-0.5 rounded"><Icon name="Lightning" size={14} weight="fill"/></div>
                            <span className="font-bold text-xs tracking-tight text-slate-800 dark:text-white">Ï£ºÎ¨∏Í¥ÄÎ¶¨ PRO</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="flex items-center bg-slate-100 dark:bg-dark-input rounded-sm p-0.5">
                                <ActionButton onClick={handleSetGoogleUrl} color="ghost" icon="Gear" text="" className="!px-1.5"/>
                                <ActionButton onClick={handleSaveToGoogle} color="ghost" icon="CloudArrowUp" text="Ï†ÄÏû•" loading={isSyncing}/>
                                <div className="w-px h-3 bg-slate-300 dark:bg-slate-600 mx-0.5"></div>
                                <ActionButton onClick={handleLoadFromGoogle} color="ghost" icon="CloudArrowDown" text="Î∂àÎü¨Ïò§Í∏∞" loading={isSyncing}/>
                            </div>
                            <div className="h-3 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md text-slate-500"><Icon name={isDarkMode ? "Sun" : "Moon"} size={14} /></button>
                            <div className="h-3 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                            <ActionButton onClick={handleCustomerUploadClick} color="brand" icon="AddressBook" text="Í≥†Í∞ù" />
                            <input type="file" ref={customerFileRef} onChange={handleCustomerFileUpload} accept=".csv" style={{display:'none'}} />
                            <div className="relative" ref={excelMenuRef}>
                                <ActionButton onClick={() => setIsExcelMenuOpen(!isExcelMenuOpen)} color="ghost" icon="FileXls" text="ÏóëÏÖÄ" />
                                {isExcelMenuOpen && (
                                    <div className="absolute top-full right-0 mt-1 w-32 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border shadow-soft rounded-md z-50 py-1">
                                        <button onClick={() => { handleDownloadCSV('full'); setIsExcelMenuOpen(false); }} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 text-slate-700 dark:text-gray-300"><Icon name="FileXls" className="text-accent-teal"/> Ï†ÑÏ≤¥</button>
                                        <button onClick={() => { handleDownloadCSV('invoice'); setIsExcelMenuOpen(false); }} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 text-slate-700 dark:text-gray-300"><Icon name="Truck" className="text-brand-600"/> ÏÜ°Ïû•</button>
                                        <button onClick={() => { handleDownloadProductCSV(); setIsExcelMenuOpen(false); }} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 border-t border-slate-100 dark:border-dark-border mt-0.5 pt-0.5 text-slate-700 dark:text-gray-300"><Icon name="List" className="text-accent-amber"/> Î∞úÏ£º</button>
                                    </div>
                                )}
                            </div>
                            <ActionButton onClick={handleDownloadHTML} color="white" icon="FloppyDisk" text="Î∞±ÏóÖ" />
                            <ActionButton onClick={handleUploadClick} color="white" icon="UploadSimple" text="Î≥µÏõê" />
                            <ActionButton onClick={handleReset} color="ghost" icon="Eraser" text="Ï¥àÍ∏∞Ìôî" />
                            <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} />
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col p-2 gap-2 overflow-hidden">
                        <div className="shrink-0"><SummarySection stats={stats} handleUnpaidFilterClick={handleUnpaidFilterClick} unpaidFilter={unpaidFilter} /></div>

                        {/* Middle: Editor Panels */}
                        <div className="shrink-0 grid grid-cols-1 lg:grid-cols-3 gap-2 h-64">
                            <div className="lg:col-span-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col shadow-soft">
                                <div className="flex justify-between items-center mb-1 px-1">
                                    <h3 className="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-1"><Icon name="ClipboardList" className="text-brand-500"/> Ï£ºÎ¨∏ÏÑú ÏûÖÎ†•</h3>
                                </div>
                                <textarea className="flex-1 w-full p-2 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-md resize-none text-xs font-mono focus:border-brand-500 outline-none transition-all mb-2 text-slate-700 dark:text-gray-200 placeholder-slate-400" placeholder="Ï£ºÎ¨∏ ÎÇ¥Ïö©ÏùÑ Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî. (Ïòà: @ÌôçÍ∏∏Îèô AÏÑ∏Ìä∏ 1Í∞ú)" value={rawInput} onChange={(e) => setRawInput(e.target.value)}></textarea>
                                <button onClick={handleParseOrders} disabled={isProcessing} className="w-full py-1.5 bg-brand-700 hover:bg-brand-800 text-white rounded-md text-xs font-bold transition-colors flex justify-center items-center gap-1 shadow-sm">{isProcessing ? 'Ï≤òÎ¶¨ Ï§ë...' : 'Î≥ÄÌôòÌïòÍ∏∞'} <Icon name="ArrowRight" size={10} weight="bold"/></button>
                            </div>
                            
                            <div className="lg:col-span-1 h-full overflow-hidden">
                                <InlineProductManager productHistory={productHistory} setProductHistory={setProductHistory} setOrders={setOrders} showToast={showToast} />
                            </div>

                            <div className="lg:col-span-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col shadow-soft">
                                <div className="flex justify-between items-center mb-1 px-1">
                                    <h3 className="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-1"><Icon name="Note" className="text-accent-amber"/> Î©îÎ™®Ïû•</h3>
                                    <button onClick={handleCopyMemo} className="text-[10px] text-slate-400 hover:text-brand-600 transition-colors"><Icon name="Copy" size={12}/></button>
                                </div>
                                <textarea className="flex-1 w-full p-2 bg-yellow-50/50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/20 rounded-md resize-none text-xs focus:border-accent-amber outline-none transition-all text-slate-700 dark:text-gray-200" value={globalMemo} onChange={(e) => setGlobalMemo(e.target.value)} onKeyDown={handleMemoKeyDown}></textarea>
                            </div>
                        </div>

                        {/* List */}
                        <div className="flex-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col overflow-hidden shadow-soft min-h-0">
                            <div className="p-1.5 border-b border-slate-100 dark:border-dark-border flex items-center justify-between gap-2 bg-slate-50/50 dark:bg-dark-bg/50">
                                <div className="flex items-center gap-2 flex-1 max-w-sm">
                                    <div className="relative flex-1">
                                        <div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div>
                                        <input className="w-full pl-7 pr-2 py-1 bg-white dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm text-xs focus:border-brand-500 outline-none transition-all text-slate-700 dark:text-gray-200 placeholder-slate-400" placeholder="Í≤ÄÏÉâ..." value={filterText} onChange={(e) => setFilterText(e.target.value)} />
                                    </div>
                                </div>
                                <div className="flex items-center gap-1.5">
                                    <div className="hidden md:flex items-center gap-1 bg-white dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm px-1.5 py-0.5">
                                        <span className="text-[9px] text-slate-400 font-bold uppercase mr-1">Í∏∞Î≥∏</span>
                                        <input type="text" value={defaultProductName} onChange={(e) => setDefaultProductName(e.target.value)} className="w-16 bg-transparent text-xs font-medium outline-none text-slate-700 dark:text-gray-200" placeholder="ÏûÖÎ†•" />
                                    </div>
                                    <div className="hidden md:flex items-center gap-1 bg-white dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm px-1.5 py-0.5">
                                        <span className="text-[9px] text-slate-400 font-bold uppercase mr-1">Îã®Í∞Ä</span>
                                        <input type="number" value={pricePerUnit} onChange={(e) => setPricePerUnit(e.target.value)} className="w-10 bg-transparent text-xs font-mono text-right outline-none text-slate-700 dark:text-gray-200" placeholder="0" />
                                    </div>
                                    <div className="hidden md:flex items-center gap-1 bg-white dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm px-1.5 py-0.5">
                                        <span className="text-[9px] text-slate-400 font-bold uppercase mr-1">Î∞∞ÏÜ°ÎπÑ</span>
                                        <input type="number" value={shippingFee} onChange={(e) => setShippingFee(Number(e.target.value))} className="w-10 bg-transparent text-xs font-mono text-right outline-none text-slate-700 dark:text-gray-200" />
                                    </div>
                                    <div className="h-3 w-px bg-slate-200 dark:border-dark-border mx-0.5 hidden md:block"></div>
                                    <ActionButton onClick={handleAddEmptyOrder} color="brand" icon="Plus" text="Ï∂îÍ∞Ä" />
                                    <ActionButton onClick={handleCopyResults} color="white" icon="Copy" text="Î≥µÏÇ¨" />
                                </div>
                            </div>

                            <div className="grid grid-rows-compact gap-2 px-3 py-1.5 bg-slate-100/50 dark:bg-dark-bg border-b border-slate-200 dark:border-dark-border text-[10px] font-bold text-slate-500 dark:text-slate-400 text-center uppercase tracking-wide">
                                <div>Ï£ºÏÜå</div><div className="text-left">Ï£ºÎ¨∏Ïûê</div><div className="text-left">ÏÉÅÌíàÎ™Ö</div><div>ÏàòÎüâ</div><div className="text-right">Í∏àÏï°</div><div>ÏÉÅÌÉú</div><div className="text-left">Î©îÎ™®</div><div></div>
                            </div>

                            <div className="flex-1 overflow-y-auto p-0 bg-white dark:bg-dark-bg/20">
                                {filteredOrders.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-full text-slate-300 dark:text-slate-600 gap-2">
                                        <Icon name="Package" size={24} className="opacity-50"/>
                                        <span className="text-xs font-medium">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</span>
                                    </div>
                                ) : (
                                    <div className="divide-y divide-slate-100 dark:divide-dark-border">
                                        {filteredOrders.map((order, index) => {
                                            const isFirst = firstOrderIds[order.customer] === order.id;
                                            const rowBg = order.price > 0 && (order.deposit + order.cardAmount < order.price) ? 'bg-accent-rose/5 dark:bg-accent-rose/10' : 'bg-white dark:bg-dark-card hover:bg-slate-50 dark:hover:bg-dark-input transition-colors';
                                            const nickColor = getNicknameColor(order.customer);
                                            
                                            return (
                                                <div key={order.id} className={`group relative grid grid-rows-compact gap-2 px-3 py-1 items-center text-xs ${rowBg}`}>
                                                    <div className="flex justify-center">
                                                        <button onClick={() => handleToggleAddressEdit(order.id)} className={`w-5 h-5 rounded-sm flex items-center justify-center transition-colors ${order.isAddressFilled ? 'bg-brand-600 text-white shadow-sm' : 'text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'}`}>
                                                            <Icon name="MapPin" size={10} weight={order.isAddressFilled ? "bold" : "regular"}/>
                                                        </button>
                                                    </div>
                                                    <div className="relative pl-1">
                                                        <div className="flex items-center gap-1">
                                                            {order.isCRM && <Icon name="Star" size={10} className="text-accent-amber" weight="fill" />}
                                                            <input id={`customer-${index}`} className={`w-full bg-transparent font-bold outline-none ${nickColor}`} value={order.customer} onChange={e => handleUpdateOrder(order.id, 'customer', e.target.value)} onKeyDown={e => handleKeyDown(e, index, 'customer')} placeholder="Ïù¥Î¶Ñ" />
                                                        </div>
                                                        {order.phone && <div className="text-[9px] text-slate-400 font-mono -mt-0.5 truncate">{order.phone}</div>}
                                                        {customerCounts[order.customer] > 1 && <span className="absolute right-0 top-0.5 text-[8px] bg-slate-100 dark:bg-slate-700 px-1 rounded-sm font-bold text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-600">{customerCounts[order.customer]}</span>}
                                                    </div>
                                                    <div className="relative"><ProductAutocomplete id={`product-${index}`} value={order.product} onChange={(e) => handleUpdateOrder(order.id, 'product', e.target.value)} onSelect={(name, price) => handleProductSelect(order.id, name, price)} onDeleteProduct={handleDeleteProduct} onKeyDown={(e) => handleKeyDown(e, index, 'product')} priceMap={productHistory} /></div>
                                                    <div className="flex justify-center"><input id={`quantity-${index}`} type="number" className="w-full text-center bg-transparent font-bold outline-none focus:bg-slate-50 dark:focus:bg-dark-input rounded-sm text-slate-700 dark:text-gray-300" value={order.quantity} onChange={e => handleUpdateOrder(order.id, 'quantity', Number(e.target.value))} onKeyDown={e => handleKeyDown(e, index, 'quantity')} /></div>
                                                    <div className="text-right"><input id={`price-${index}`} className="w-full text-right bg-transparent font-mono font-medium outline-none focus:bg-slate-50 dark:focus:bg-dark-input rounded-sm text-slate-700 dark:text-gray-300" value={order.price === 0 ? '' : order.price.toLocaleString()} onChange={e => { const v = e.target.value.replace(/,/g,''); if(!isNaN(v)) handleUpdateOrder(order.id, 'price', Number(v)); }} onKeyDown={e => handleKeyDown(e, index, 'price')} placeholder="0" /></div>
                                                    <div className="flex items-center justify-center gap-1">
                                                        <button onClick={() => handleAutoDepositFull(order.id)} className={`h-4.5 px-1.5 rounded-sm flex items-center justify-center text-[9px] font-bold border transition-all ${order.deposit > 0 ? 'bg-accent-teal/10 text-accent-teal border-accent-teal/30' : 'bg-transparent text-slate-300 border-slate-200 dark:border-slate-700 hover:border-slate-300'}`}>ÌòÑÍ∏à</button>
                                                        {isFirst ? (
                                                            <button onClick={() => handleUpdateOrder(order.id, 'isShippingPaid', !order.isShippingPaid)} onContextMenu={(e) => { e.preventDefault(); handleToggleShippingEdit(order.id); }} className={`h-4.5 px-1.5 rounded-sm flex items-center justify-center text-[9px] font-bold transition-colors ${order.isShippingPaid ? 'bg-slate-700 text-white' : 'bg-slate-100 text-slate-400 dark:bg-slate-800'}`}>Î∞∞ÏÜ°</button>
                                                        ) : (
                                                            <span className="h-4.5 px-1.5 rounded-sm flex items-center justify-center text-[9px] font-bold text-transparent border border-transparent select-none">Î∞∞ÏÜ°</span>
                                                        )}
                                                        <button onClick={() => handleToggleAmountEdit(order.id)} className={`h-4.5 px-1.5 rounded-sm flex items-center justify-center text-[9px] font-bold border transition-all ${order.cardAmount > 0 ? 'bg-accent-rose/10 text-accent-rose border-accent-rose/30' : 'bg-transparent text-slate-300 border-slate-200 dark:border-slate-700 hover:border-slate-300'}`}>Ïπ¥Îìú</button>
                                                    </div>
                                                    <div><input id={`memo-${index}`} className="w-full bg-transparent text-slate-500 dark:text-slate-400 outline-none text-xs focus:text-slate-800 dark:focus:text-white" value={order.memo} onChange={e => handleUpdateOrder(order.id, 'memo', e.target.value)} onKeyDown={e => handleKeyDown(e, index, 'memo')} placeholder="-" /></div>
                                                    <div className="flex justify-end"><button onClick={() => handleDelete(order.id)} className="text-slate-300 hover:text-accent-rose transition-colors p-1"><Icon name="X" size={10}/></button></div>

                                                    {/* Editor Popups */}
                                                    {editingAmountId === order.id && ( <div className="col-span-full p-1.5 bg-slate-50 dark:bg-dark-input border-y border-slate-200 dark:border-dark-border flex gap-2 justify-end items-center animate-fade-in shadow-inner"> <button onClick={() => handleAutoCardFull(order.id)} className="px-2 py-0.5 rounded-sm bg-accent-rose text-white hover:bg-rose-600 text-[10px] font-bold shadow-sm">Ïπ¥Îìú Ï†ÑÏï°</button> <div className="flex items-center gap-1 bg-white dark:bg-dark-card px-2 py-0.5 rounded-sm border border-slate-200 dark:border-dark-border"><span className="text-[9px] text-slate-400">ÌòÑÍ∏à</span><input type="number" className="w-14 text-right text-xs font-bold outline-none bg-transparent" value={order.deposit} onChange={e => handleUpdateOrder(order.id, 'deposit', Number(e.target.value))} /></div><div className="flex items-center gap-1 bg-white dark:bg-dark-card px-2 py-0.5 rounded-sm border border-slate-200 dark:border-dark-border"><span className="text-[9px] text-slate-400">Ïπ¥Îìú</span><input type="number" className="w-14 text-right text-xs font-bold outline-none bg-transparent" value={order.cardAmount} onChange={e => handleUpdateOrder(order.id, 'cardAmount', Number(e.target.value))} /></div></div> )}
                                                    {editingShippingId === order.id && ( <div className="col-span-full p-1.5 bg-brand-50 dark:bg-brand-900/20 border-y border-brand-100 dark:border-brand-800 flex gap-2 justify-center items-center animate-fade-in shadow-inner"> <span className="text-[10px] font-bold text-brand-600 dark:text-brand-300">Í∞úÎ≥Ñ Î∞∞ÏÜ°ÎπÑ:</span> <input type="number" className="w-16 p-0.5 rounded-sm border border-brand-200 text-right font-bold text-xs text-brand-700 outline-none" value={order.customShippingFee ?? shippingFee} onChange={e => handleUpdateOrder(order.id, 'customShippingFee', Number(e.target.value))} /> <button onClick={() => handleUpdateOrder(order.id, 'customShippingFee', null)} className="text-[10px] bg-white text-brand-600 px-2 py-0.5 rounded-sm border border-brand-200 hover:bg-brand-50">Í∏∞Î≥∏Í∞í</button> <button onClick={() => setEditingShippingId(null)} className="text-[10px] bg-brand-600 text-white px-2 py-0.5 rounded-sm hover:bg-brand-700 ml-1">ÌôïÏù∏</button> </div> )}
                                                    {editingAddressId === order.id && ( <div className="col-span-full"><AddressEditor order={order} handleUpdateOrder={handleUpdateOrder} handleUpdateOrderBatch={handleUpdateOrderBatch} setEditingAddressId={setEditingAddressId} showToast={showToast} /></div> )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                            
                            <div className="p-1.5 bg-slate-50 dark:bg-dark-bg border-t border-slate-200 dark:border-dark-border text-xs flex justify-between items-center shrink-0">
                                <div className="flex items-center gap-2"><span className="px-2 py-0.5 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-sm text-[10px] font-bold text-slate-500 dark:text-slate-400 shadow-sm">Î∞∞ÏÜ° {filteredStats.shippingCount}Í±¥</span></div>
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-1"><span className="text-[10px] text-slate-400">Ï¥ùÏï°</span><span className="font-bold text-slate-700 dark:text-white font-mono">{filteredStats.totalRev.toLocaleString()}</span></div>
                                    {filteredStats.totalUnpaid > 0 && (<div className="flex items-center gap-1 pl-3 border-l border-slate-200 dark:border-slate-700"><span className="text-[10px] text-accent-rose font-bold">ÎØ∏ÏûÖÍ∏à</span><span className="font-bold text-accent-rose font-mono">{filteredStats.totalUnpaid.toLocaleString()}</span></div>)}
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    {toast && (
                        <div className="fixed top-6 right-6 px-4 py-2.5 bg-slate-800 text-white rounded-md shadow-lg flex items-center gap-2 animate-fade-in z-[100] border-l-4 border-brand-500">
                            <Icon name={toast.type==='error'?'WarningCircle':'CheckCircle'} className={toast.type==='error'?'text-accent-rose':'text-accent-teal'} size={14} weight="fill"/> 
                            <span className="font-medium text-xs tracking-wide">{toast.message}</span>
                        </div>
                    )}
                </div>
            );
        };
        
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (error) {
            document.body.innerHTML = `<div style="color:red; padding:20px;"><h3>Critical Error</h3><pre>${error.message}</pre></div>`;
            console.error(error);
        }
    </script>
</body>
</html>
