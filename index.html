<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì€ì§€ ì£¼ë¬¸ì„œìš©</title>
    
    <!-- Daum Postcode ì •ì  ë¡œë”© -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <!-- ë¦¬ì•¡íŠ¸ ë° í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    
    <!-- PapaParse CDN for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            input: '#334155',
                            text: '#e2e8f0',
                            muted: '#94a3b8',
                            border: '#334155',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .animate-bounce-in { animation: bounce-in 0.5s ease-out; }
        @keyframes bounce-in { 
            0% { transform: scale(0.5) translateY(100%); opacity: 0; } 
            70% { transform: scale(1.05) translateY(-5px); opacity: 1; } 
            100% { transform: scale(1) translateY(0); } 
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-bg text-slate-900 dark:text-dark-text transition-colors duration-200">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- GLOBAL UTILITIES ---

        const sanitizeOrder = (order) => {
            if (!order || typeof order !== 'object') return null;
            
            const sanitized = {
                id: order.id || Date.now() + Math.random(),
                customer: order.customer || '',
                product: order.product || '',
                quantity: Number(order.quantity) || 1,
                price: Number(order.price) || 0,
                deposit: Number(order.deposit) || 0,
                cardAmount: Number(order.cardAmount) || 0,
                isPaid: !!order.isPaid,
                isCardPaid: !!order.isCardPaid,
                isShippingPaid: !!order.isShippingPaid,
                customShippingFee: order.customShippingFee === null ? null : (Number(order.customShippingFee) || 0),
                memo: order.memo || '',
                originalText: order.originalText || '',
                recipientName: order.recipientName || '',
                phone: order.phone || '', 
                zipCode: order.zipCode || '',
                addressText: order.addressText || '',
                shippingMemo: order.shippingMemo || '',
            };
            
            sanitized.isAddressFilled = !!sanitized.recipientName && !!sanitized.phone && !!sanitized.addressText;
            return sanitized;
        };

        const Icon = React.memo(({ name, size = 24, className = "" }) => {
            const map = {
                ClipboardList: "ph-clipboard-text", FileDown: "ph-download-simple", Trash2: "ph-trash", Plus: "ph-plus",
                Search: "ph-magnifying-glass", Youtube: "ph-youtube-logo", CheckCircle: "ph-check-circle", 
                ShoppingCart: "ph-shopping-cart", DollarSign: "ph-currency-dollar", CreditCard: "ph-credit-card",
                Truck: "ph-truck", Copy: "ph-copy", X: "ph-x", Pencil: "ph-pencil-simple",
                Moon: "ph-moon", FloppyDisk: "ph-floppy-disk", Clock: "ph-clock-countdown", Money: "ph-money", Package: "ph-package",
                ArrowRight: "ph-arrow-right", UploadSimple: "ph-upload-simple", Note: "ph-note-pencil", MapPin: "ph-map-pin",
                Address: "ph-map-pin", User: "ph-user", Brain: "ph-brain"
            };
            return <i className={`ph-bold ${map[name] || 'ph-question'} ${className}`} style={{ fontSize: size }}></i>;
        });

        const DashboardCard = React.memo(({ icon, color, title, subTitle, value, isCurrency = true }) => {
            const isUnpaid = title.includes('ë¯¸ì…ê¸ˆ');
            const textColor = isUnpaid ? 'text-red-600 dark:text-red-400' : 'text-slate-900 dark:text-dark-text';

            return (
                <div className="bg-white dark:bg-dark-card px-3 py-2 rounded-xl shadow-sm border border-slate-200 dark:border-dark-border flex items-center h-[66px] transition-transform hover:scale-[1.01] overflow-hidden relative">
                    <div className={`flex-none p-2 rounded-lg mr-3 flex items-center justify-center ${color} h-12 w-12 min-w-[3rem] min-h-[3rem]`}>
                        <Icon name={icon} size={28} />
                    </div>
                    <div className="flex-1 flex flex-col justify-center h-full min-w-0">
                        <div className="flex justify-between items-end mb-0.5">
                             <span className="text-sm font-extrabold text-slate-600 dark:text-dark-muted leading-none">{title}</span>
                             {subTitle && <span className="text-xs font-bold text-slate-400 dark:text-slate-500 leading-none">{subTitle}</span>}
                        </div>
                        <div className="text-right -mt-0.5">
                            <p className={`text-2xl font-extrabold ${textColor} tracking-tighter leading-none break-keep`}>
                                {typeof value === 'number' ? value.toLocaleString() : value}
                                {isCurrency ? <span className="text-xs font-bold ml-0.5 align-baseline">ì›</span> : <span className="text-xs font-bold ml-0.5 align-baseline">ê°œ</span>}
                            </p>
                        </div>
                    </div>
                </div>
            );
        });

        const ActionButton = React.memo(({ onClick, color, icon, text }) => (
            <button onClick={onClick} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 whitespace-nowrap transition-colors shadow-sm
                ${color === 'blue' ? 'bg-blue-600 hover:bg-blue-700 text-white' : 
                  'bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-dark-input dark:hover:bg-slate-600 dark:text-dark-text'}`}>
                <Icon name={icon} size={16}/> {text}
            </button>
        ));

        const parseAddressInfo = (text) => {
            const result = { recipientName: '', phone: '', zipCode: '', addressText: '', shippingMemo: '' };
            let remainingText = text.replace(/\n/g, ' ').trim();

            // 1. ì „í™”ë²ˆí˜¸ ì¶”ì¶œ (ê°œì„ ë¨: íŠ¹ìˆ˜ë¬¸ìê°€ ì„ì—¬ ìˆì–´ë„ 010ìœ¼ë¡œ ì‹œì‘í•˜ê³  ìˆ«ì íŒ¨í„´ì´ ë§ìœ¼ë©´ ì¶”ì¶œ)
            // ì˜ˆ: 010-1234-5678, 010.1234.5678, 010 1234 5678, 010*1234*5678 ëª¨ë‘ ê°€ëŠ¥
            // 010 ë’¤ì— ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì(\D)ê°€ 0ê°œ ì´ìƒ ìˆê³ , ìˆ«ì 3~4ê°œ, ë‹¤ì‹œ ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì 0ê°œ ì´ìƒ, ìˆ«ì 4ê°œ
            const phoneRegex = /010[\D]*\d{3,4}[\D]*\d{4}/;
            const phoneMatch = remainingText.match(phoneRegex);
            
            if (phoneMatch) {
                const rawPhone = phoneMatch[0];
                const digitsOnly = rawPhone.replace(/\D/g, '');
                
                if (digitsOnly.startsWith('010') && (digitsOnly.length === 10 || digitsOnly.length === 11)) {
                     result.phone = digitsOnly; 
                     remainingText = remainingText.replace(rawPhone, ' ').trim();
                }
            }

            // 2. ìš°í¸ë²ˆí˜¸
            const zipMatch = remainingText.match(/\d{5,6}/);
            if (zipMatch) {
                result.zipCode = zipMatch[0];
                remainingText = remainingText.replace(zipMatch[0], ' ');
            }

            // 3. ì„±í•¨ (ì „í™”ë²ˆí˜¸, ìš°í¸ë²ˆí˜¸ ì œê±° í›„ ë‚¨ì€ í…ìŠ¤íŠ¸ì˜ ì²« ë‹¨ì–´ ë˜ëŠ” ì´ë¦„ íŒ¨í„´)
            const words = remainingText.split(/\s+/).filter(w => w.length > 0);
            if (words.length > 0) {
                // 2~4ê¸€ì í•œê¸€ì„ ì´ë¦„ìœ¼ë¡œ ì¶”ì •
                const potentialName = words.find(w => /^[ê°€-í£]{2,4}$/.test(w));
                if (potentialName) {
                    result.recipientName = potentialName;
                    remainingText = remainingText.replace(potentialName, ' ');
                } else {
                    // ì´ë¦„ íŒ¨í„´ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë‹¨ì–´ë¥¼ ì´ë¦„ìœ¼ë¡œ ê°€ì • (ë‹¨, ì£¼ì†Œ í‚¤ì›Œë“œê°€ ì•„ë‹ ê²½ìš°)
                    const firstWord = words[0];
                    const isAddressKeyword = ['ì‹œ', 'ë„', 'êµ¬', 'êµ°', 'ì', 'ë©´', 'ë™', 'ê°€', 'ë¡œ', 'ê¸¸'].some(kw => firstWord.endsWith(kw));
                    if (!isAddressKeyword) {
                        result.recipientName = firstWord;
                         remainingText = remainingText.replace(firstWord, ' ');
                    }
                }
            }

            // 4. ì£¼ì†Œ
            const addressKeywords = ['ì‹œ', 'ë„', 'íŠ¹ë³„ì‹œ', 'ê´‘ì—­ì‹œ', 'íŠ¹ë³„ìì¹˜ì‹œ', 'íŠ¹ë³„ìì¹˜ë„', 'êµ¬', 'êµ°', 'ì', 'ë©´', 'ë™', 'ê°€', 'ë¡œ', 'ê¸¸', 'ë²ˆì§€', 'ì•„íŒŒíŠ¸', 'ì‚°ë‹¨'];
            let addressMatch = remainingText.match(new RegExp(`([ê°€-í£0-9\\s-]*(${addressKeywords.join('|')})[ê°€-í£0-9\\s,-]*)`, 'g'));

            if (addressMatch) {
                let bestMatch = addressMatch.reduce((a, b) => a.length > b.length ? a : b, '');
                if (bestMatch.length > 2) { 
                    result.addressText = bestMatch.trim();
                    remainingText = remainingText.replace(bestMatch, ' ');
                }
            }

            // 5. ë°°ì†¡ë©”ëª¨ (ë‚˜ë¨¸ì§€)
            result.shippingMemo = remainingText.replace(/(ë°°ì†¡|ìš”ì²­|ë©”ëª¨|ì‚¬í•­)[:\s]*/g, '').trim();
            
            return result;
        };

        const AddressEditor = ({ order, handleUpdateOrder, handleUpdateOrderBatch, setEditingAddressId, showToast }) => {
            const [rawAddressText, setRawAddressText] = useState('');

            const handleOpenAddressSearch = () => {
                if (window.daum && window.daum.Postcode) {
                    try {
                        new daum.Postcode({
                            oncomplete: function(data) {
                                let fullAddress = data.roadAddress || data.jibunAddress;
                                let extraAddress = '';
                                if(data.userSelectedType === 'R'){
                                    if(data.bname !== '') extraAddress += data.bname;
                                    if(data.buildingName !== '') extraAddress += (extraAddress !== '' ? `, ${data.buildingName}` : data.buildingName);
                                    if(extraAddress !== '') fullAddress += ` (${extraAddress})`;
                                }
                                const updates = {
                                    zipCode: data.zonecode,
                                    addressText: fullAddress
                                };
                                handleUpdateOrderBatch(order.id, updates);
                                showToast('ì£¼ì†Œê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        }).open();
                    } catch (error) {
                        fallbackToNaver();
                    }
                } else {
                    fallbackToNaver();
                }
            };
            
            const fallbackToNaver = () => {
                showToast('ë„¤ì´ë²„ ê²€ìƒ‰ ì°½ì„ ì—½ë‹ˆë‹¤.', 'error');
                window.open('https://search.naver.com/search.naver?query=%EC%9A%B0%ED%8E%B8%EB%B2%88%ED%98%B8%EA%B2%80%EC%83%89', '_blank');
            }

            const handleParse = () => {
                if (!rawAddressText.trim()) { showToast('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
                const parsed = parseAddressInfo(rawAddressText);
                const updates = {
                    recipientName: parsed.recipientName || order.recipientName,
                    phone: parsed.phone || order.phone,
                    zipCode: parsed.zipCode || order.zipCode,
                    addressText: parsed.addressText || order.addressText,
                    shippingMemo: parsed.shippingMemo || order.shippingMemo,
                };
                // ì¼ê´„ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
                handleUpdateOrderBatch(order.id, updates);
                showToast('ë³€í™˜ ì™„ë£Œ! (ê°™ì€ ë‹‰ë„¤ì„ ì¼ê´„ ì ìš©)');
                setRawAddressText('');
            };

            const handleChange = (field, value) => {
                handleUpdateOrderBatch(order.id, { [field]: value });
            };

            const inputClass = "w-full p-2 border border-slate-300 dark:border-dark-border rounded-md text-sm dark:bg-dark-input dark:text-dark-text focus:ring-2 focus:ring-indigo-500 transition-colors";

            return (
                <div className="col-span-full p-4 bg-slate-100 dark:bg-dark-card rounded-lg shadow-inner mt-1 space-y-3 border border-slate-200 dark:border-dark-border">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-200 dark:border-dark-border">
                        <h3 className="text-sm font-bold text-slate-800 dark:text-dark-text flex items-center gap-2">
                            <Icon name="MapPin" size={20} className="text-indigo-500"/> {order.customer} ë‹˜ì˜ ë°°ì†¡ ì •ë³´
                        </h3>
                        <div className="flex gap-2">
                            <ActionButton onClick={handleOpenAddressSearch} color="slate" icon="Search" text="ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰" />
                            <ActionButton onClick={() => setEditingAddressId(null)} color="blue" icon="FloppyDisk" text="ì €ì¥/ë‹«ê¸°" />
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <textarea
                            className="flex-1 p-2 border border-slate-300 dark:border-dark-border rounded-md text-xs dark:bg-dark-input dark:text-dark-text focus:ring-2 resize-none h-16"
                            placeholder="ë°°ì†¡ ì •ë³´ ë¶™ì—¬ë„£ê¸° (ì˜ˆ: ê°•ì€ì§€ 010.212.2121 ê´‘ì‚°êµ¬ í‰ë™ì‚°ë‹¨3ë²ˆë¡œ85...)"
                            value={rawAddressText}
                            onChange={(e) => setRawAddressText(e.target.value)}
                        />
                        <button onClick={handleParse} className="w-20 flex-none py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-md text-sm font-bold">ë³€í™˜</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div><label className="block text-xs font-bold mb-1 text-slate-600 dark:text-dark-muted">ìˆ˜ë ¹ì¸</label><input type="text" value={order.recipientName} onChange={(e) => handleChange('recipientName', e.target.value)} className={inputClass} placeholder="í•„ìˆ˜" /></div>
                        <div><label className="block text-xs font-bold mb-1 text-slate-600 dark:text-dark-muted">ì—°ë½ì²˜</label><input type="text" value={order.phone} onChange={(e) => handleChange('phone', e.target.value)} className={inputClass} placeholder="í•„ìˆ˜" /></div>
                        <div><label className="block text-xs font-bold mb-1 text-slate-600 dark:text-dark-muted">ìš°í¸ë²ˆí˜¸</label><input type="text" value={order.zipCode} onChange={(e) => handleChange('zipCode', e.target.value)} className={inputClass} placeholder="ì„ íƒ" /></div>
                        <div><label className="block text-xs font-bold mb-1 text-slate-600 dark:text-dark-muted">ë°°ì†¡ ë©”ëª¨</label><input type="text" value={order.shippingMemo} onChange={(e) => handleChange('shippingMemo', e.target.value)} className={inputClass} /></div>
                    </div>
                    <div><label className="block text-xs font-bold mb-1 text-slate-600 dark:text-dark-muted">ì£¼ì†Œ</label><input type="text" value={order.addressText} onChange={(e) => handleChange('addressText', e.target.value)} className={inputClass} placeholder="í•„ìˆ˜" /></div>
                </div>
            );
        };

        // --- Custom Autocomplete Component ---
        const ProductAutocomplete = ({ id, value, onChange, onSelect, onKeyDown, priceMap }) => {
            const [showSuggestions, setShowSuggestions] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setShowSuggestions(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const filtered = Object.entries(priceMap).filter(([name]) => 
                name.toLowerCase().includes(value.toLowerCase())
            );

            const handleSelect = (name, price) => {
                onSelect(name, price);
                setShowSuggestions(false);
            };

            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <input 
                        id={id}
                        className="w-full bg-transparent outline-none text-slate-900 dark:text-dark-text text-base font-bold tracking-tight font-sans"
                        value={value}
                        onChange={(e) => {
                            onChange(e);
                            setShowSuggestions(true);
                        }}
                        onFocus={() => setShowSuggestions(true)}
                        onKeyDown={onKeyDown}
                        placeholder="ìƒí’ˆëª…"
                        autoComplete="off"
                    />
                    {showSuggestions && filtered.length > 0 && (
                        <ul className="absolute z-50 left-0 mt-1 w-full bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-lg max-h-48 overflow-y-auto">
                            {filtered.map(([name, price]) => (
                                <li 
                                    key={name}
                                    className="px-3 py-2 hover:bg-indigo-50 dark:hover:bg-slate-700 cursor-pointer flex justify-between items-center text-sm border-b border-slate-100 dark:border-dark-border last:border-0"
                                    onClick={() => handleSelect(name, price)}
                                >
                                    <span className="font-bold text-slate-800 dark:text-dark-text truncate mr-2">{name}</span>
                                    <span className="text-xs text-slate-500 dark:text-dark-muted flex-none bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">{price.toLocaleString()}ì›</span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        const App = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            const [rawInput, setRawInput] = useState('');
            const [globalMemo, setGlobalMemo] = useState(() => localStorage.getItem('globalMemo') || '');
            
            const [productHistory, setProductHistory] = useState(() => {
                try { return JSON.parse(localStorage.getItem('productHistory')) || {}; } catch { return {}; }
            });

            const [orders, setOrders] = useState(() => {
                try { 
                    const stored = JSON.parse(localStorage.getItem('youtubeOrders'));
                    if (Array.isArray(stored)) return stored.map(sanitizeOrder).filter(o => o !== null);
                    return [];
                } catch { return []; }
            });
            const [isProcessing, setIsProcessing] = useState(false);
            const [toast, setToast] = useState(null);
            const [pricePerUnit, setPricePerUnit] = useState('');
            const [shippingFee, setShippingFee] = useState(4000);
            const [defaultProductName, setDefaultProductName] = useState('');
            const [filterText, setFilterText] = useState('');
            const [editingAmountId, setEditingAmountId] = useState(null);
            const [editingAddressId, setEditingAddressId] = useState(null); 
            const ordersRef = useRef(orders);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (isDarkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDarkMode]);

            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); ordersRef.current = orders; }, [orders]);
            useEffect(() => { localStorage.setItem('globalMemo', globalMemo); }, [globalMemo]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);

            const getCSVString = (listData) => {
                 const list = [...listData].map(sanitizeOrder).sort((a, b) => (a.customer || '').localeCompare(b.customer || ''));
                const firstIds = {};
                list.forEach(o => { if (o.customer && !firstIds[o.customer]) firstIds[o.customer] = o.id; });
                
                // ìš”ì²­í•˜ì‹  ì—‘ì…€ í—¤ë” êµ¬ì¡° (A~D ê³µë€, Eë¶€í„° ë°ì´í„° ì‹œì‘, J, M ê³µë€)
                const excelHeaders = [
                    '', '', '', '',         // A, B, C, D (ê³µë€)
                    'ìƒí’ˆëª…',               // E
                    'ìˆ˜ë ¹ì¸',               // F
                    'ì—°ë½ì²˜',               // G
                    'ì£¼ì†Œ',                 // H
                    'ë°°ì†¡ë©”ëª¨',             // I
                    '',                     // J (ê³µë€)
                    'ë©”ëª¨',                 // K
                    'ìš°í¸ë²ˆí˜¸',             // L
                    ''                      // M (ê³µë€)
                ];

                const csv = [excelHeaders.join(',')].concat(
                    list.map(o => {
                        // ìƒí’ˆëª… í¬ë§· ë³€ê²½: ìˆ˜ëŸ‰ ì¡°ê±´ë¶€ í‘œì‹œ
                        // ìˆ˜ëŸ‰ì´ 2 ì´ìƒì¼ ê²½ìš°ì—ë§Œ â˜…ìˆ˜ëŸ‰ í‘œì‹œ, ê·¸ ì™¸(0, 1)ëŠ” í‘œì‹œ ì•ˆ í•¨
                        let quantitySuffix = '';
                        if (o.quantity >= 2) {
                            quantitySuffix = ` â˜…${o.quantity}`;
                        }
                        
                        const productName = `[${o.customer || 'ë¯¸ì§€ì •'}] ${o.product}${quantitySuffix}`;
                        
                        const clean = (val) => `"${String(val || '').replace(/"/g, '""')}"`;
                        
                        // ì—‘ì…€ì—ì„œ 0ì´ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ ="ê°’" í˜•íƒœë¡œ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
                        const cleanPhone = (val) => {
                            if (!val) return '""';
                            // ="ê°’" í˜•íƒœë¡œ ë§Œë“¤ì–´ clean í•¨ìˆ˜ì— ì „ë‹¬ (CSV ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ í¬í•¨)
                            return clean(`="${String(val)}"`);
                        };
                        
                        return [
                            '', '', '', '',                     // A, B, C, D
                            clean(productName),                 // E: ìƒí’ˆëª…
                            clean(o.recipientName),             // F: ìˆ˜ë ¹ì¸
                            cleanPhone(o.phone),                // G: ì—°ë½ì²˜
                            clean(o.addressText),               // H: ì£¼ì†Œ
                            clean(o.shippingMemo),              // I: ë°°ì†¡ë©”ëª¨
                            '',                                 // J
                            clean(o.memo),                      // K: ë©”ëª¨
                            cleanPhone(o.zipCode),              // L: ìš°í¸ë²ˆí˜¸
                            ''                                  // M
                        ].join(',');
                    })
                ).join('\n');
                return "\ufeff" + csv;
            };
            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 3000); };
            
            const handleDownloadCSV = (silent = false) => {
                if (ordersRef.current.length === 0) return;
                const csvContent = getCSVString(ordersRef.current);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; 
                const fileName = `ê°•ì€ì§€_ì£¼ë¬¸ì„œ_${new Date().toLocaleDateString()}.csv`;
                a.download = fileName;
                a.click(); URL.revokeObjectURL(url);
                if (!silent) showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
            };

            const handleKeyDown = (e, index, field) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    const nextIndex = index + 1;
                    if (nextIndex < filteredOrders.length) {
                        const nextElement = document.getElementById(`${field}-${nextIndex}`);
                        if (nextElement) {
                            nextElement.focus();
                            if (nextElement.select) nextElement.select();
                        }
                    }
                }
            };

            const handleMemoKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const textarea = e.target;
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const value = globalMemo;
                    const newValue = value.substring(0, start) + "\nâ–« " + value.substring(end);
                    setGlobalMemo(newValue);
                    setTimeout(() => {
                        textarea.selectionStart = textarea.selectionEnd = start + 3; 
                    }, 0);
                }
            };
            const handleCopyMemo = () => {
                if (!globalMemo) { showToast('ë³µì‚¬í•  ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                const ta = document.createElement("textarea"); ta.value = globalMemo; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                showToast('ë©”ëª¨ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            };
            const getNicknameColor = (name) => {
                if (!name) return 'text-slate-900 dark:text-dark-text';
                const colors = ['text-red-600 dark:text-red-400', 'text-orange-600 dark:text-orange-400', 'text-amber-600 dark:text-amber-400', 'text-green-600 dark:text-green-400', 'text-emerald-600 dark:text-emerald-400', 'text-teal-600 dark:text-teal-400', 'text-cyan-600 dark:text-cyan-400', 'text-blue-600 dark:text-blue-400', 'text-indigo-600 dark:text-indigo-400', 'text-violet-600 dark:text-violet-400', 'text-purple-600 dark:text-purple-400', 'text-fuchsia-600 dark:text-fuchsia-400', 'text-pink-600 dark:text-pink-400', 'text-rose-600 dark:text-rose-400'];
                let hash = 0;
                for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
                return colors[Math.abs(hash) % colors.length];
            };

            const handleParseOrders = () => {
                if (!rawInput.trim()) { showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
                setIsProcessing(true);
                setTimeout(() => {
                    const blocks = rawInput.split(/\n\s*\n/).filter(block => block.trim() !== '');
                    const newOrders = blocks.map((block, i) => {
                        const lines = block.trim().split('\n').map(l => l.trim()).filter(l => l);
                        if (lines.length === 0) return null;

                        let rawCustomer = lines[0].replace(/@/g, '').trim();
                        let customer = rawCustomer.replace(/-[a-zA-Z0-9]+$/, '').trim();
                        let product = lines.slice(1).join(' ').trim() || defaultProductName;
                        let quantity = 1; 
                        
                        let unitPrice = productHistory[product] || Number(pricePerUnit) || 0;
                        const price = quantity * unitPrice;
                        
                        // ì£¼ì†Œì •ë³´ ìë™ì™„ì„± (ê°™ì€ ë‹‰ë„¤ì„ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì£¼ì†Œ ì •ë³´ ë³µì‚¬)
                        const existingOrder = orders.find(o => o.customer === customer);
                        
                        let recipientName = '';
                        let zipCode = '';
                        let addressText = '';
                        let shippingMemo = '';
                        let phone = '';

                        if (existingOrder) {
                             recipientName = existingOrder.recipientName;
                             phone = existingOrder.phone;
                             zipCode = existingOrder.zipCode;
                             addressText = existingOrder.addressText;
                             shippingMemo = existingOrder.shippingMemo;
                        }

                        return sanitizeOrder({
                            id: Date.now() + i + Math.random(),
                            originalText: block, 
                            customer, 
                            product, 
                            quantity, 
                            price,
                            phone, 
                            deposit: 0, isPaid: false, isShippingPaid: false, isCardPaid: false, cardAmount: 0, customShippingFee: null, memo: '', 
                            recipientName, zipCode, addressText, shippingMemo, 
                        });
                    }).filter(o => o !== null);

                    setOrders(prev => [...newOrders, ...prev]);
                    setRawInput('');
                    setIsProcessing(false);
                    showToast(`${newOrders.length}ê±´ ì¶”ê°€ ì™„ë£Œ! (ì£¼ì†Œ ìë™ì™„ì„± í¬í•¨)`);
                }, 100);
            };
            
            const handleAddEmptyOrder = () => { setOrders(prev => [sanitizeOrder({ id: Date.now(), customer: '', product: defaultProductName, quantity: 1, price: Number(pricePerUnit) || 0 }), ...prev]); };
            
            const handleUpdateOrder = (id, field, value) => {
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    let updates = { [field]: value };
                    
                    if (field === 'quantity') {
                        const savedUnitPrice = productHistory[o.product] || Number(pricePerUnit) || 0;
                        updates.price = value * savedUnitPrice;
                    }
                    
                    if (field === 'product') {
                        const savedUnitPrice = productHistory[value];
                        if (savedUnitPrice !== undefined) {
                            updates.price = o.quantity * savedUnitPrice;
                        }
                    }

                    if (field === 'price') {
                        if (o.product && o.quantity > 0) {
                            const unitPrice = value / o.quantity;
                            setProductHistory(prevHist => ({ ...prevHist, [o.product]: unitPrice }));
                        }
                    }

                    const newPrice = updates.price ?? o.price;
                    if (field === 'deposit') { const rem = Math.max(0, newPrice - value); updates.cardAmount = rem; updates.isCardPaid = rem > 0; }
                    return sanitizeOrder({ ...o, ...updates });
                }));
            };

            // Custom handler for product selection from autocomplete
            const handleProductSelect = (id, product, unitPrice) => {
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    return sanitizeOrder({
                        ...o,
                        product: product,
                        price: o.quantity * unitPrice
                    });
                }));
            };

            // ì¼ê´„ ì—…ë°ì´íŠ¸ + ë™ì¼ ë‹‰ë„¤ì„ ì£¼ì†Œ ìë™ ë™ê¸°í™” ê¸°ëŠ¥ ê°•í™”
            const handleUpdateOrderBatch = (id, updates) => {
                setOrders(prev => {
                    const targetOrder = prev.find(o => o.id === id);
                    if (!targetOrder || !targetOrder.customer) return prev; // ë‹‰ë„¤ì„ ì—†ìœ¼ë©´ ì¼ê´„ì²˜ë¦¬ ë¶ˆê°€

                    const isAddressUpdate = ['recipientName', 'phone', 'zipCode', 'addressText', 'shippingMemo'].some(key => key in updates);
                    const targetCustomer = targetOrder.customer.trim(); // ê³µë°± ì œê±° í›„ ë¹„êµ

                    return prev.map(o => {
                        if (o.id === id) {
                            return sanitizeOrder({ ...o, ...updates });
                        }
                        // ë‹‰ë„¤ì„ì´ ê°™ìœ¼ë©´(ê³µë°± ì œê±° ë¹„êµ) í•¨ê»˜ ì—…ë°ì´íŠ¸
                        if (isAddressUpdate && o.customer && o.customer.trim() === targetCustomer) {
                            return sanitizeOrder({ ...o, ...updates });
                        }
                        return o;
                    });
                });
            };

            const handleDelete = (id) => setOrders(prev => prev.filter(o => o.id !== id));
            const handleAutoDepositFull = (id) => { setOrders(prev => prev.map(o => o.id === id ? sanitizeOrder({ ...o, deposit: o.price + (o.isShippingPaid ? 0 : (o.customShippingFee ?? shippingFee)), cardAmount: 0, isPaid: true, isCardPaid: false, isShippingPaid: true }) : o)); setEditingAmountId(null); };
            const handleAutoCardFull = (id) => { setOrders(prev => prev.map(o => o.id === id ? sanitizeOrder({ ...o, deposit: 0, cardAmount: o.price, isPaid: true, isCardPaid: true }) : o)); setEditingAmountId(null); };
            const handleDownloadHTML = () => { const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'ê°•ì€ì§€_ì£¼ë¬¸ì„œ.html'; a.click(); URL.revokeObjectURL(url); showToast('ì•± íŒŒì¼ ì €ì¥ ì™„ë£Œ!'); };
            const handleUploadClick = () => fileInputRef.current && fileInputRef.current.click();
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => {
                    const uploaded = results.data.map((row, i) => sanitizeOrder({
                        id: Date.now() + i, originalText: `UPLOAD: ${row['ìƒí’ˆëª…']}`, customer: row['ë‹‰ë„¤ì„']?.trim(), product: row['ìƒí’ˆëª…'], quantity: Number(row['ìˆ˜ëŸ‰']) || 1, price: Number(row['ê¸ˆì•¡']?.replace(/,/g, '')) || 0,
                        deposit: Number(row['ì…ê¸ˆì•¡(í˜„ê¸ˆ)']), cardAmount: Number(row['ì¹´ë“œê²°ì œì•¡']), recipientName: row['ìˆ˜ë ¹ì¸'], phone: row['ì—°ë½ì²˜'], zipCode: row['ìš°í¸ë²ˆí˜¸'], addressText: row['ì£¼ì†Œ'], shippingMemo: row['ë°°ì†¡ë©”ëª¨'], memo: row['ë©”ëª¨']
                    })).filter(o => o.customer);
                    setOrders(prev => [...uploaded, ...prev]); showToast(`${uploaded.length}ê±´ ì—…ë¡œë“œ ì™„ë£Œ!`);
                }});
                e.target.value = null;
            };
            const handleCopyResults = () => {
                if (filteredOrders.length === 0) return;
                let text = '';
                const grouped = filteredOrders.reduce((acc, o) => { (acc[o.customer] = acc[o.customer] || []).push(o); return acc; }, {});
                Object.entries(grouped).forEach(([name, items]) => {
                    text += `ğŸ’™ ${name} ë‹˜ ğŸ’™\n\n`;
                    items.forEach(o => text += `${o.product} ${o.price.toLocaleString()}\n`);
                    const shipFee = items[0].customShippingFee ?? shippingFee;
                    if (shipFee > 0) text += `ë°°ì†¡ë¹„ ${shipFee.toLocaleString()}\n`;
                    text += `-\n`; 
                    const cardTotal = items.reduce((s, o) => s + o.cardAmount, 0);
                    const depositTotal = items.reduce((s, o) => s + o.deposit, 0);
                    if (cardTotal > 0) {
                        const cardFee = Math.round(cardTotal * 0.10); 
                        const totalCardPayment = cardTotal + cardFee;
                        text += `ì…ê¸ˆ ${depositTotal.toLocaleString()}\n`; 
                        text += `ì¹´ë“œ ${cardTotal.toLocaleString()}\n`; 
                        text += `ì´ ì¹´ë“œê²°ì œ (10%) \n${totalCardPayment.toLocaleString()} ì˜ˆì •\n`; 
                    } else if (depositTotal > 0) {
                        text += `ì…ê¸ˆ ${depositTotal.toLocaleString()}\n`; 
                    }
                    text += `Â -\n`; 
                    const itemTotal = items.reduce((s, o) => s + o.price, 0);
                    const paidTotal = depositTotal + cardTotal;
                    const isShipPaid = items.some(o => o.isShippingPaid);
                    const shipUnpaid = (shipFee > 0 && !isShipPaid) ? shipFee : 0;
                    const totalUnpaid = Math.max(0, itemTotal - paidTotal) + shipUnpaid;
                    if (totalUnpaid > 0) {
                        text += `ë¯¸ì…ê¸ˆ: ${totalUnpaid.toLocaleString()}ì›\n\n`;
                    } else {
                        text += `ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜\n\n`; 
                    }
                });
                const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('ì£¼ë¬¸ ë‚´ì—­ ë³µì‚¬ ì™„ë£Œ!');
            };

            const firstOrderIds = useMemo(() => { const ids = {}; orders.forEach(o => { if (o.customer && !ids[o.customer]) ids[o.customer] = o.id; }); return ids; }, [orders]);
            const customerCounts = useMemo(() => orders.reduce((acc, o) => { if(o.customer) acc[o.customer] = (acc[o.customer] || 0) + 1; return acc; }, {}), [orders]);
            const filteredOrders = useMemo(() => { if (!filterText) return orders; const lower = filterText.toLowerCase(); return orders.filter(o => (o.customer && o.customer.toLowerCase().includes(lower)) || (o.product && o.product.toLowerCase().includes(lower))); }, [orders, filterText]);
            const stats = useMemo(() => {
                const res = { qty: 0, cardRev: 0, cashRev: 0, shipRev: 0, unpaidItem: 0, unpaidShip: 0, cardCount: 0, cashCount: 0, shipCount: 0 };
                const grouped = orders.reduce((acc, o) => { const k = o.customer||'u'; if(!acc[k]) acc[k] = {p:0, d:0, c:0, ship:false, fee:null}; acc[k].p+=o.price; acc[k].d+=o.deposit; acc[k].c+=o.cardAmount; if(o.isShippingPaid) acc[k].ship=true; if(o.customShippingFee!==null) acc[k].fee=o.customShippingFee; return acc; }, {});
                Object.values(grouped).forEach(g => {
                    const ship = g.fee ?? shippingFee; res.shippingCount++; res.shippingRevenue += ship;
                    if (g.c > 0) { res.cardCount++; res.cardRev += g.c; }
                    if (g.d > 0) { res.cashCount++; res.cashRev += g.d; }
                    res.qty = orders.reduce((s, o) => s + o.quantity, 0);
                    res.unpaidItem += Math.max(0, g.p - (g.d + g.c));
                    if (!g.ship && ship > 0) res.unpaidShip += ship;
                });
                return res;
            }, [orders, shippingFee]);
            const filteredStats = useMemo(() => { 
                 let res = { shippingCount: 0, productRevenue: 0, shippingRevenue: 0, cardTotal: 0, productUnpaid: 0, shippingUnpaid: 0 };
                 const grouped = filteredOrders.reduce((acc, o) => { const k = o.customer||'u'; if(!acc[k]) acc[k] = {p:0, d:0, c:0, ship:false, fee:null}; acc[k].p+=o.price; acc[k].d+=o.deposit; acc[k].c+=o.cardAmount; if(o.isShippingPaid) acc[k].ship=true; if(o.customShippingFee!==null) acc[k].fee=o.customShippingFee; return acc; }, {});
                 Object.values(grouped).forEach(g => {
                     const ship = g.fee ?? shippingFee; res.shippingCount++; res.shippingRevenue += ship; res.productRevenue += g.p; res.cardTotal += g.c;
                     res.productUnpaid += Math.max(0, g.p - (g.d + g.c));
                     if (!g.ship && ship > 0) res.shippingUnpaid += ship;
                 });
                 return res;
            }, [filteredOrders, shippingFee]);
            
            const handleToggleAmountEdit = (id) => {
                setEditingAmountId(id === editingAmountId ? null : id);
            };

            const handleToggleAddressEdit = (id) => {
                setEditingAddressId(id === editingAddressId ? null : id);
            };

            return (
                <div className="min-h-screen flex flex-col text-slate-900 dark:text-dark-text">
                    <header className="sticky top-0 z-50 bg-white/80 dark:bg-dark-card/80 backdrop-blur-md border-b border-slate-200 dark:border-dark-border flex-none">
                        <div className="max-w-[1920px] mx-auto px-6 h-16 flex items-center justify-between overflow-x-auto gap-6">
                            <div className="flex items-center gap-3 text-indigo-600 dark:text-indigo-400 min-w-fit">
                                <Icon name="Package" size={28} />
                                <h1 className="text-xl font-bold text-slate-900 dark:text-dark-text hidden md:block">ê°•ì€ì§€ ì£¼ë¬¸ì„œìš©</h1>
                            </div>
                            <div className="flex items-center gap-3 text-sm whitespace-nowrap">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-yellow-500">
                                    <Icon name="Moon" size={20} />
                                </button>
                                <button onClick={handleDownloadHTML} className="px-3 py-1 bg-indigo-600 text-white rounded">ì•± ì €ì¥</button>
                                <button onClick={handleUploadClick} className="px-3 py-1 bg-slate-600 text-white rounded">ì—…ë¡œë“œ</button>
                                <button onClick={() => handleDownloadCSV(false)} className="px-3 py-1 bg-green-600 text-white rounded">ë‹¤ìš´</button>
                                <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-[1920px] mx-auto w-full px-6 py-6 flex flex-col gap-2">
                        {/* ìë™ì™„ì„±ì„ ìœ„í•œ datalist ì¶”ê°€ (ìƒí’ˆëª… + ê°€ê²© ì •ë³´ í‘œì‹œ) */}
                        <datalist id="product-options">
                            {Object.entries(productHistory).map(([product, price]) => (
                                <option key={product} value={product} label={`${price.toLocaleString()}ì›`} />
                            ))}
                        </datalist>

                        <div className="flex-none grid grid-cols-2 md:grid-cols-3 gap-2">
                            <DashboardCard icon="CreditCard" color="bg-pink-100 text-pink-600" title="ì¹´ë“œ ê²°ì œ" subTitle={`(${stats.cardCount}ëª…)`} value={stats.cardRev} />
                            <DashboardCard icon="Money" color="bg-emerald-100 text-emerald-600" title="í˜„ê¸ˆ ê²°ì œ" subTitle={`(${stats.cashCount}ëª…)`} value={stats.cashRev} />
                            <DashboardCard icon="Truck" color="bg-cyan-100 text-cyan-600" title="ì´ ë°°ì†¡ë¹„" subTitle={`(${stats.shipCount}ê±´)`} value={stats.shipRev} />
                            <DashboardCard icon="ClipboardList" color="bg-blue-100 text-blue-600" title="ì´ ì£¼ë¬¸ ìˆ˜ëŸ‰" value={stats.qty} isCurrency={false} />
                            <DashboardCard icon="DollarSign" color="bg-red-100 text-red-600" title="ë¯¸ì…ê¸ˆ (ìƒí’ˆ)" value={stats.unpaidItem} />
                            <DashboardCard icon="Truck" color="bg-orange-100 text-orange-600" title="ë¯¸ì…ê¸ˆ (ë°°ì†¡ë¹„)" value={stats.unpaidShip} />
                        </div>

                        <div className="flex flex-col gap-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 flex-none h-48 md:h-56">
                                <div className="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-slate-200 dark:border-dark-border p-4 flex flex-col h-full">
                                    <div className="flex items-center justify-between mb-2 h-8">
                                        <h2 className="text-sm font-bold flex items-center gap-2 text-slate-900 dark:text-dark-text">
                                            <div className="w-1 h-4 bg-indigo-500 rounded-full"></div>ëŒ“ê¸€ ë¶™ì—¬ë„£ê¸°
                                        </h2>
                                    </div>
                                    <textarea 
                                        className="flex-1 w-full p-3 border border-slate-300 dark:border-dark-border rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none text-sm dark:bg-dark-input dark:text-dark-text mb-3 leading-relaxed" 
                                        placeholder="ì˜ˆ: @ê¹€ì² ìˆ˜ \n Aì„¸íŠ¸ 2ê°œ \n\n @ì˜í¬ \n Bì„¸íŠ¸ 1ê°œ" 
                                        value={rawInput} 
                                        onChange={(e) => setRawInput(e.target.value)}
                                    ></textarea>
                                    <button onClick={handleParseOrders} disabled={isProcessing} className="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm transition-colors flex justify-center items-center gap-2">
                                        {isProcessing ? 'ë³€í™˜ ì¤‘...' : 'ì£¼ë¬¸ì„œ ë³€í™˜'} <Icon name="ArrowRight" size={16}/>
                                    </button>
                                </div>

                                <div className="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-slate-200 dark:border-dark-border p-4 flex flex-col h-full relative">
                                    <div className="flex justify-between items-center mb-2 h-8">
                                        <h2 className="text-sm font-bold flex items-center gap-2 text-slate-900 dark:text-dark-text">
                                            <div className="w-1 h-4 bg-yellow-500 rounded-full"></div>ë©”ëª¨ì¥
                                        </h2>
                                        <button onClick={handleCopyMemo} className="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors" title="ë©”ëª¨ ë³µì‚¬">
                                            <Icon name="Copy" size={18}/>
                                        </button>
                                    </div>
                                    <textarea 
                                        className="flex-1 w-full p-3 border border-slate-300 dark:border-dark-border rounded-lg focus:ring-2 focus:ring-yellow-500 resize-none text-sm dark:bg-dark-input dark:text-dark-text leading-relaxed" 
                                        placeholder="ììœ ë¡­ê²Œ ë©”ëª¨í•˜ì„¸ìš”... (ì—”í„° í‚¤ë¡œ ì¤„ êµ¬ë¶„)"
                                        value={globalMemo}
                                        onChange={(e) => setGlobalMemo(e.target.value)}
                                        onKeyDown={handleMemoKeyDown}
                                    ></textarea>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-slate-200 dark:border-dark-border flex flex-col">
                                <div className="p-3 border-b border-slate-100 dark:border-dark-border flex flex-nowrap gap-2 items-center justify-between bg-slate-50/50 dark:bg-dark-card overflow-x-auto">
                                    <div className="flex items-center gap-2 w-40 flex-none">
                                        <div className="relative flex-1">
                                            <div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={14} /></div>
                                            <input className="w-full pl-7 pr-2 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 dark:bg-dark-input dark:border-dark-border dark:text-dark-text" 
                                                placeholder="ê²€ìƒ‰" value={filterText} onChange={(e) => setFilterText(e.target.value)} />
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center gap-2 text-xs flex-none">
                                        <div className="flex items-center bg-white dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1.5">
                                            <span className="text-slate-500 dark:text-dark-muted mr-2">ìƒí’ˆ:</span>
                                            <input type="text" value={defaultProductName} onChange={(e) => setDefaultProductName(e.target.value)} className="w-32 bg-transparent outline-none font-bold text-slate-700 dark:text-dark-text text-sm" placeholder="ê¸°ë³¸" />
                                        </div>
                                        <div className="flex items-center bg-white dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1.5">
                                            <span className="text-slate-500 dark:text-dark-muted mr-2">ë‹¨ê°€:</span>
                                            <input type="number" value={pricePerUnit} onChange={(e) => setPricePerUnit(e.target.value)} className="w-20 bg-transparent outline-none font-bold text-right text-slate-700 dark:text-dark-text text-sm" placeholder="0" />
                                        </div>
                                        <div className="flex items-center bg-white dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1.5">
                                            <span className="text-slate-500 dark:text-dark-muted mr-2">ë°°ì†¡:</span>
                                            <input type="number" value={shippingFee} onChange={(e) => setShippingFee(Number(e.target.value))} className="w-20 bg-transparent outline-none font-bold text-right text-slate-700 dark:text-dark-text text-sm" />
                                        </div>
                                        <ActionButton onClick={handleAddEmptyOrder} color="blue" icon="Plus" text="ì¶”ê°€" />
                                    </div>

                                    <div className="flex items-center gap-2 flex-none">
                                        <ActionButton onClick={handleCopyResults} color="slate" icon="Copy" text="ë³µì‚¬" />
                                        <ActionButton onClick={() => setOrders([])} color="slate" icon="Trash2" />
                                    </div>
                                </div>

                                <div className="sticky top-16 z-40 grid grid-cols-[0.5fr_2.0fr_4.0fr_0.4fr_1.0fr_1.5fr_2.0fr_0.5fr] gap-4 p-3 bg-slate-100 dark:bg-dark-input text-xs font-bold text-slate-500 dark:text-dark-muted border-b dark:border-dark-border text-center shadow-sm">
                                    <div className="text-center">ì£¼ì†Œ</div><div className="text-left">ë‹‰ë„¤ì„/ì…ê¸ˆëª…</div><div className="text-left">ìƒí’ˆëª…</div><div className="text-center">ìˆ˜ëŸ‰</div><div class="text-right">ê¸ˆì•¡</div><div class="text-center">ìƒíƒœ</div><div class="text-center">ë©”ëª¨</div><div class="text-center">ì‚­ì œ</div>
                                </div>

                                <div className="p-2 space-y-2">
                                    {filteredOrders.map((order, index) => {
                                        const isFirst = firstOrderIds[order.customer] === order.id;
                                        const addressIconClass = order.isAddressFilled ? 'bg-slate-900 text-white dark:bg-slate-200 dark:text-slate-900' : 'bg-slate-50 text-slate-300 hover:bg-slate-100 dark:bg-dark-input dark:text-slate-600 dark:hover:bg-slate-700';
                                        const nickColor = getNicknameColor(order.customer);
                                        
                                        let moneyIcon = order.deposit > 0 ? (order.cardAmount > 0 ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600') : 'bg-slate-50 text-slate-300 dark:bg-dark-input dark:text-slate-600';
                                        let cardIcon = order.cardAmount > 0 ? 'bg-pink-100 text-pink-500' : 'bg-slate-50 text-slate-300 dark:bg-dark-input dark:text-slate-600';

                                        return (
                                            <React.Fragment key={order.id}>
                                                <div className={`grid grid-cols-[0.5fr_2.0fr_4.0fr_0.4fr_1.0fr_1.5fr_2.0fr_0.5fr] gap-4 p-3 border rounded-lg items-center text-sm transition-colors ${order.price > 0 && (order.deposit + order.cardAmount < order.price) ? 'bg-red-50 border-red-100 dark:bg-red-900/20 dark:border-red-900' : 'bg-white border-slate-100 dark:bg-dark-card dark:border-dark-border'}`}>
                                                    <div className="flex justify-center"><button onClick={() => handleToggleAddressEdit(order.id)} className={`w-9 h-9 rounded-full flex items-center justify-center transition-all ${addressIconClass}`}><Icon name="MapPin" size={20}/></button></div>
                                                    <div className="relative pl-1">
                                                        <input id={`customer-${index}`} onKeyDown={e => handleKeyDown(e, index, 'customer')} className={`w-full bg-transparent font-bold outline-none text-base ${nickColor}`} value={order.customer} onChange={e => handleUpdateOrder(order.id, 'customer', e.target.value)} placeholder="ë‹‰ë„¤ì„" />
                                                        <input id={`phone-${index}`} onKeyDown={e => handleKeyDown(e, index, 'phone')} className="w-full bg-transparent text-slate-400 dark:text-slate-500 text-xs outline-none block mt-0.5" value={order.phone} onChange={e => handleUpdateOrder(order.id, 'phone', e.target.value)} placeholder="ì…ê¸ˆëª…" />
                                                        {customerCounts[order.customer] > 1 && <span className="absolute right-0 top-0 text-[10px] bg-slate-200 dark:bg-slate-600 px-1.5 rounded-full text-slate-600 dark:text-slate-300 font-bold">{customerCounts[order.customer]}</span>}
                                                    </div>
                                                    
                                                    {/* ì»¤ìŠ¤í…€ ìë™ì™„ì„± ì»´í¬ë„ŒíŠ¸ ì ìš© */}
                                                    <div>
                                                        <ProductAutocomplete 
                                                            id={`product-${index}`}
                                                            value={order.product}
                                                            onChange={(e) => handleUpdateOrder(order.id, 'product', e.target.value)}
                                                            onSelect={(name, price) => handleProductSelect(order.id, name, price)}
                                                            onKeyDown={(e) => handleKeyDown(e, index, 'product')}
                                                            priceMap={productHistory}
                                                        />
                                                    </div>

                                                    <div className="flex justify-center"><input id={`quantity-${index}`} onKeyDown={e => handleKeyDown(e, index, 'quantity')} type="number" className="w-full text-center bg-slate-50 dark:bg-dark-input rounded font-bold dark:text-dark-text" value={order.quantity} onChange={e => handleUpdateOrder(order.id, 'quantity', Number(e.target.value))} /></div>
                                                    <div className="text-right"><input id={`price-${index}`} onKeyDown={e => handleKeyDown(e, index, 'price')} className="w-full text-right bg-transparent font-bold dark:text-dark-text" value={order.price === 0 ? '' : order.price.toLocaleString()} onChange={e => { const v = e.target.value.replace(/,/g,''); if(!isNaN(v)) handleUpdateOrder(order.id, 'price', Number(v)); }} placeholder="0" /></div>
                                                    <div className="flex justify-center gap-1">
                                                        <button onClick={() => handleAutoDepositFull(order.id)} className={`w-9 h-9 rounded-full flex justify-center items-center transition-all ${moneyIcon}`}><Icon name="DollarSign" size={27}/></button>
                                                        {isFirst ? <button onClick={() => handleUpdateOrder(order.id, 'isShippingPaid', !order.isShippingPaid)} className={`w-9 h-9 rounded-full flex justify-center items-center transition-all ${order.isShippingPaid ? 'bg-blue-100 text-blue-600' : 'bg-slate-50 text-slate-300 dark:bg-dark-input dark:text-slate-600'}`}><Icon name="Truck" size={27}/></button> : <div className="w-9"/>}
                                                        <button onClick={() => handleToggleAmountEdit(order.id)} className={`w-9 h-9 rounded-full flex justify-center items-center transition-all ${cardIcon}`}><Icon name="CreditCard" size={27}/></button>
                                                    </div>
                                                    <div><input id={`memo-${index}`} onKeyDown={e => handleKeyDown(e, index, 'memo')} className="w-full text-center bg-transparent outline-none dark:text-dark-text" value={order.memo} onChange={e => handleUpdateOrder(order.id, 'memo', e.target.value)} placeholder="ë©”ëª¨" /></div>
                                                    <div className="flex justify-center"><button onClick={() => handleDelete(order.id)} className="text-slate-300 hover:text-red-500 dark:text-slate-600"><Icon name="Trash2" size={18}/></button></div>
                                                </div>
                                                {editingAmountId === order.id && (
                                                    <div className="col-span-full p-2 bg-slate-100 dark:bg-dark-input rounded flex gap-2 justify-end items-center">
                                                        {/* í•‘í¬ìƒ‰ ì¹´ë“œ ì•„ì´ì½˜ ë²„íŠ¼ (í˜„ê¸ˆ ì¹¸ ì™¼ìª½) */}
                                                        <button onClick={() => handleAutoCardFull(order.id)} className="w-8 h-8 rounded-md flex items-center justify-center bg-pink-100 text-pink-600 hover:bg-pink-200 transition-colors" title="ì¹´ë“œ ì „ì•¡ ê²°ì œ">
                                                            <Icon name="CreditCard" size={20}/>
                                                        </button>
                                                        
                                                        <span className="text-xs font-bold dark:text-dark-text">í˜„ê¸ˆ:</span><input type="number" className="w-24 p-1 rounded border dark:bg-dark-card dark:border-dark-border dark:text-white" value={order.deposit} onChange={e => handleUpdateOrder(order.id, 'deposit', Number(e.target.value))} />
                                                        <span className="text-xs font-bold dark:text-dark-text">ì¹´ë“œ:</span><input type="number" className="w-24 p-1 rounded border dark:bg-dark-card dark:border-dark-border dark:text-white" value={order.cardAmount} onChange={e => handleUpdateOrder(order.id, 'cardAmount', Number(e.target.value))} />
                                                    </div>
                                                )}
                                                {editingAddressId === order.id && <AddressEditor order={order} handleUpdateOrder={handleUpdateOrder} handleUpdateOrderBatch={handleUpdateOrderBatch} setEditingAddressId={setEditingAddressId} showToast={showToast} />}
                                            </React.Fragment>
                                        );
                                    })}
                                </div>
                                <div className="p-4 bg-slate-50 dark:bg-dark-input border-t border-slate-200 dark:border-dark-border text-sm flex justify-between items-center rounded-b-xl">
                                    <div className="text-xs text-slate-500 dark:text-dark-muted">ì´ {filteredStats.shippingCount}ëª… ë°°ì†¡ ì˜ˆì •</div>
                                    <div className="text-right flex gap-4">
                                        <div className="font-bold dark:text-dark-text">í•©ê³„ <span className="text-indigo-600 dark:text-indigo-400">{(filteredStats.productRevenue + filteredStats.shippingRevenue).toLocaleString()}ì›</span></div>
                                        {(filteredStats.productUnpaid + filteredStats.shippingUnpaid) > 0 && <div className="font-bold text-red-500 dark:text-red-400">ë¯¸ì…ê¸ˆ: {(filteredStats.productUnpaid + filteredStats.shippingUnpaid).toLocaleString()}ì›</div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                    {toast && <div className="fixed bottom-6 right-6 px-4 py-3 bg-slate-800 text-white rounded-xl shadow-xl flex items-center gap-2 animate-bounce-in z-50"><Icon name={toast.type==='error'?'X':'CheckCircle'} className={toast.type==='error'?'text-red-400':'text-green-400'}/> {toast.message}</div>}
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body></html>
