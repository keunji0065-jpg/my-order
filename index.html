<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•ì€ì§€ ì£¼ë¬¸ì„œ ìë™í™” v1.3 (Final)</title>
    
    <!-- Daum Postcode ì •ì  ë¡œë”© -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <!-- ë¦¬ì•¡íŠ¸ ë° í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    
    <!-- PapaParse CDN for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'Roboto', 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            900: '#312e81',
                        },
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            input: '#334155',
                            text: '#e2e8f0',
                            muted: '#94a3b8',
                            border: '#334155',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Pretendard', sans-serif; -webkit-font-smoothing: antialiased; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Glassmorphism utilities */
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(30, 41, 59, 0.7); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-bg text-slate-900 dark:text-dark-text transition-colors duration-300 selection:bg-brand-100 dark:selection:bg-brand-900">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- GLOBAL UTILITIES ---

        const sanitizeOrder = (order) => {
            if (!order || typeof order !== 'object') return null;
            
            const sanitized = {
                id: order.id || Date.now() + Math.random(),
                customer: order.customer || '',
                product: order.product || '',
                quantity: Number(order.quantity) || 1,
                price: Number(order.price) || 0,
                deposit: Number(order.deposit) || 0,
                cardAmount: Number(order.cardAmount) || 0,
                isPaid: !!order.isPaid,
                isCardPaid: !!order.isCardPaid,
                isShippingPaid: !!order.isShippingPaid,
                customShippingFee: order.customShippingFee === null ? null : (Number(order.customShippingFee) || 0),
                memo: order.memo || '',
                originalText: order.originalText || '',
                recipientName: order.recipientName || '',
                phone: order.phone || '', 
                zipCode: order.zipCode || '',
                addressText: order.addressText || '',
                shippingMemo: order.shippingMemo || '',
            };
            
            sanitized.isAddressFilled = !!sanitized.recipientName && !!sanitized.phone && !!sanitized.addressText;
            return sanitized;
        };

        const Icon = React.memo(({ name, size = 20, className = "" }) => {
            const map = {
                ClipboardList: "ph-clipboard-text", FileDown: "ph-download-simple", Trash2: "ph-trash", Plus: "ph-plus",
                Search: "ph-magnifying-glass", Youtube: "ph-youtube-logo", CheckCircle: "ph-check-circle", 
                ShoppingCart: "ph-shopping-cart", DollarSign: "ph-currency-dollar", CreditCard: "ph-credit-card",
                Truck: "ph-truck", Copy: "ph-copy", X: "ph-x", Pencil: "ph-pencil-simple",
                Moon: "ph-moon", FloppyDisk: "ph-floppy-disk", Clock: "ph-clock-countdown", Money: "ph-money", Package: "ph-package",
                ArrowRight: "ph-arrow-right", UploadSimple: "ph-upload-simple", Note: "ph-note-pencil", MapPin: "ph-map-pin",
                Address: "ph-map-pin", User: "ph-user", Brain: "ph-brain", ChartBar: "ph-chart-bar", WarningCircle: "ph-warning-circle",
                Wallet: "ph-wallet", TrendUp: "ph-trend-up", Coins: "ph-coins", Bank: "ph-bank", Receipt: "ph-receipt",
                HandCoins: "ph-hand-coins", Calculator: "ph-calculator", Eraser: "ph-eraser", List: "ph-list",
                CaretDown: "ph-caret-down", FileXls: "ph-file-xls"
            };
            return <i className={`ph-bold ${map[name] || 'ph-question'} ${className}`} style={{ fontSize: size }}></i>;
        });

        // --- COMPONENT: Top Summary Card (Clean Design without Main Icon) ---
        const SummaryDashboardCard = React.memo(({ totalRevenue, orderCount, shippingCount }) => {
            return (
                <div className="bg-gradient-to-br from-indigo-600 to-violet-600 dark:from-indigo-900 dark:to-violet-900 px-8 py-5 rounded-2xl shadow-lg text-white relative overflow-hidden border border-indigo-500/30 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div className="text-center md:text-left z-10">
                        <p className="text-indigo-200 text-xs font-bold mb-1 tracking-wide uppercase">ì „ì²´ ë§¤ì¶œ (ì˜ˆìƒ)</p>
                        <p className="text-4xl font-black tracking-tight leading-none drop-shadow-md">
                            {totalRevenue.toLocaleString()}
                            <span className="text-xl ml-1 font-medium opacity-70 align-baseline">ì›</span>
                        </p>
                    </div>
                    
                    <div className="flex gap-10 z-10 border-t md:border-t-0 border-white/20 pt-3 md:pt-0 w-full md:w-auto justify-around md:justify-end">
                        <div className="text-center md:text-right">
                            <p className="text-indigo-200 text-[10px] font-bold uppercase mb-0.5 opacity-80">ì´ ì£¼ë¬¸ìˆ˜ëŸ‰</p>
                            <p className="text-xl font-bold leading-none">{orderCount}<span className="text-xs ml-0.5 opacity-70 font-normal">ê°œ</span></p>
                        </div>
                        <div className="text-center md:text-right">
                            <p className="text-indigo-200 text-[10px] font-bold uppercase mb-0.5 opacity-80">ë°°ì†¡ ì˜ˆì •</p>
                            <p className="text-xl font-bold leading-none">{shippingCount}<span className="text-xs ml-0.5 opacity-70 font-normal">ê±´</span></p>
                        </div>
                    </div>
                </div>
            );
        });

        // --- COMPONENT: Standard Dashboard Card ---
        const DashboardCard = React.memo(({ icon, color, title, value, subTitle, isCurrency = true, isUnpaid = false, onClick, isActive }) => {
            const iconBgColor = {
                pink: 'bg-pink-50 text-pink-600 dark:bg-pink-900/30 dark:text-pink-400',
                emerald: 'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400',
                cyan: 'bg-cyan-50 text-cyan-600 dark:bg-cyan-900/30 dark:text-cyan-400',
                red: 'bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400', 
                orange: 'bg-orange-50 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400',
                amber: 'bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400',
            }[color] || 'bg-slate-100 text-slate-600';

            return (
                <div 
                    onClick={onClick}
                    className={`bg-white dark:bg-dark-card px-4 py-2.5 rounded-xl shadow-sm border flex items-center gap-3 transition-all hover:shadow-md cursor-pointer h-[64px]
                    ${isUnpaid ? 'border-red-100 dark:border-red-900/30' : 'border-slate-200 dark:border-dark-border'}
                    ${isActive ? 'ring-2 ring-brand-500 dark:ring-brand-400' : ''}
                    `}
                >
                    <div className={`flex-none p-2 rounded-lg flex items-center justify-center h-10 w-10 ${iconBgColor}`}>
                        <Icon name={icon} size={20} />
                    </div>
                    <div className="flex-1 min-w-0 flex flex-col justify-center">
                        <div className="flex justify-between items-baseline">
                             <span className="text-xs font-bold text-slate-500 dark:text-slate-400 truncate">{title}</span>
                        </div>
                        <div className="text-right -mt-0.5">
                            <p className={`text-xl font-extrabold tracking-tight leading-none ${isUnpaid ? 'text-red-600 dark:text-red-500' : 'text-slate-800 dark:text-slate-200'}`}>
                                {typeof value === 'number' ? value.toLocaleString() : value}
                                {isCurrency && <span className={`text-[10px] font-medium ml-0.5 align-top ${isUnpaid ? 'text-red-400' : 'text-slate-400'}`}>ì›</span>}
                            </p>
                        </div>
                    </div>
                </div>
            );
        });

        const ProductManager = ({ isOpen, onClose, productHistory, setProductHistory }) => {
            if (!isOpen) return null;
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');

            const handleAdd = () => {
                if (!name.trim()) return;
                setProductHistory(prev => ({ ...prev, [name.trim()]: Number(price) }));
                setName(''); setPrice('');
            };

            const handleDelete = (key) => {
                setProductHistory(prev => {
                    const next = { ...prev };
                    delete next[key];
                    return next;
                });
            };

            // --- NEW: Delete All Products ---
            const handleDeleteAll = () => {
                if (window.confirm("ì •ë§ë¡œ ëª¨ë“  ìƒí’ˆ ëª©ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                    setProductHistory({});
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden border border-slate-200 dark:border-dark-border flex flex-col max-h-[80vh]">
                        <div className="p-4 border-b border-slate-100 dark:border-dark-border flex justify-between items-center bg-slate-50/50 dark:bg-dark-card">
                            <h3 className="font-bold text-lg text-slate-800 dark:text-dark-text flex items-center gap-2"><Icon name="List" size={20} className="text-brand-500"/> ìƒí’ˆ ê´€ë¦¬</h3>
                            <div className="flex gap-2">
                                <button onClick={handleDeleteAll} className="text-xs text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded hover:bg-red-50 transition-colors">ì „ì²´ ì‚­ì œ</button>
                                <button onClick={onClose} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full"><Icon name="X" size={18} /></button>
                            </div>
                        </div>
                        <div className="p-4 border-b border-slate-100 dark:border-dark-border bg-white dark:bg-dark-card">
                            <div className="flex gap-2">
                                <input className="flex-1 p-2 border border-slate-200 dark:border-dark-border rounded-lg text-sm dark:bg-dark-input dark:text-dark-text" placeholder="ìƒí’ˆëª…" value={name} onChange={e => setName(e.target.value)} />
                                <input className="w-24 p-2 border border-slate-200 dark:border-dark-border rounded-lg text-sm dark:bg-dark-input dark:text-dark-text" type="number" placeholder="ë‹¨ê°€" value={price} onChange={e => setPrice(e.target.value)} />
                                <button onClick={handleAdd} className="px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-bold hover:bg-brand-700">ë“±ë¡</button>
                            </div>
                        </div>
                        <div className="overflow-y-auto p-2 flex-1 bg-slate-50 dark:bg-dark-bg">
                            {Object.entries(productHistory).length === 0 ? (
                                <p className="text-center text-slate-400 text-sm py-8">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            ) : (
                                <ul className="space-y-1">
                                    {Object.entries(productHistory).map(([pName, pPrice]) => (
                                        <li key={pName} className="flex justify-between items-center p-3 bg-white dark:bg-dark-card rounded-lg border border-slate-100 dark:border-dark-border shadow-sm">
                                            <span className="font-medium text-slate-700 dark:text-dark-text">{pName}</span>
                                            <div className="flex items-center gap-3">
                                                <span className="text-sm text-slate-500 dark:text-slate-400 font-mono">{pPrice.toLocaleString()}ì›</span>
                                                <button onClick={() => handleDelete(pName)} className="text-red-400 hover:text-red-600 p-1"><Icon name="Trash2" size={16}/></button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ActionButton = React.memo(({ onClick, color, icon, text, className='' }) => {
            const baseClass = "px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 whitespace-nowrap transition-all shadow-sm active:scale-95";
            const colorClass = color === 'blue' 
                ? 'bg-brand-600 hover:bg-brand-700 text-white shadow-brand-500/30' 
                : color === 'white'
                    ? 'bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 dark:bg-dark-card dark:border-dark-border dark:text-slate-300 dark:hover:bg-slate-800'
                    : 'bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 dark:bg-dark-card dark:border-dark-border dark:text-slate-300 dark:hover:bg-slate-800';
            
            return (
                <button onClick={onClick} className={`${baseClass} ${colorClass} ${className}`}>
                    <Icon name={icon} size={14}/> {text}
                </button>
            );
        });

        // --- PARSERS & HELPERS ---
        const parseAddressInfo = (text) => {
            const result = { recipientName: '', phone: '', zipCode: '', addressText: '', shippingMemo: '' };
            let remainingText = text.replace(/\n/g, ' ').trim();
            const phoneMatch = remainingText.match(/010[.\-\s/]*\d{3,4}[.\-\s/]*\d{4}/);
            if (phoneMatch) {
                const rawPhone = phoneMatch[0];
                const digitsOnly = rawPhone.replace(/\D/g, '');
                if (digitsOnly.startsWith('010') && (digitsOnly.length === 10 || digitsOnly.length === 11)) {
                     result.phone = digitsOnly; 
                     remainingText = remainingText.replace(rawPhone, ' ').trim();
                }
            }
            const zipMatch = remainingText.match(/\d{5,6}/);
            if (zipMatch) {
                result.zipCode = zipMatch[0];
                remainingText = remainingText.replace(zipMatch[0], ' ');
            }
            const words = remainingText.split(/\s+/).filter(w => w.length > 0);
            if (words.length > 0) {
                const potentialName = words.find(w => /^[ê°€-í£]{2,4}$/.test(w));
                if (potentialName) {
                    result.recipientName = potentialName;
                    remainingText = remainingText.replace(potentialName, ' ');
                } else {
                    const firstWord = words[0];
                    const isAddressKeyword = ['ì‹œ', 'ë„', 'êµ¬', 'êµ°', 'ì', 'ë©´', 'ë™', 'ê°€', 'ë¡œ', 'ê¸¸'].some(kw => firstWord.endsWith(kw));
                    if (!isAddressKeyword) {
                        result.recipientName = firstWord;
                         remainingText = remainingText.replace(firstWord, ' ');
                    }
                }
            }
            const addressKeywords = ['ì‹œ', 'ë„', 'íŠ¹ë³„ì‹œ', 'ê´‘ì—­ì‹œ', 'íŠ¹ë³„ìì¹˜ì‹œ', 'íŠ¹ë³„ìì¹˜ë„', 'êµ¬', 'êµ°', 'ì', 'ë©´', 'ë™', 'ê°€', 'ë¡œ', 'ê¸¸', 'ë²ˆì§€', 'ì•„íŒŒíŠ¸', 'ì‚°ë‹¨'];
            let addressMatch = remainingText.match(new RegExp(`([ê°€-í£0-9\\s-]*(${addressKeywords.join('|')})[ê°€-í£0-9\\s,-]*)`, 'g'));
            if (addressMatch) {
                let bestMatch = addressMatch.reduce((a, b) => a.length > b.length ? a : b, '');
                if (bestMatch.length > 2) { 
                    result.addressText = bestMatch.trim();
                    remainingText = remainingText.replace(bestMatch, ' ');
                }
            }
            result.shippingMemo = remainingText.replace(/(ë°°ì†¡|ìš”ì²­|ë©”ëª¨|ì‚¬í•­)[:\s]*/g, '').trim();
            return result;
        };

        const AddressEditor = ({ order, handleUpdateOrder, handleUpdateOrderBatch, setEditingAddressId, showToast }) => {
            const [rawAddressText, setRawAddressText] = useState('');
            const handleOpenAddressSearch = () => {
                if (window.daum && window.daum.Postcode) {
                    try {
                        new daum.Postcode({
                            oncomplete: function(data) {
                                let fullAddress = data.roadAddress || data.jibunAddress;
                                let extraAddress = '';
                                if(data.userSelectedType === 'R'){
                                    if(data.bname !== '') extraAddress += data.bname;
                                    if(data.buildingName !== '') extraAddress += (extraAddress !== '' ? `, ${data.buildingName}` : data.buildingName);
                                    if(extraAddress !== '') fullAddress += ` (${extraAddress})`;
                                }
                                const updates = { zipCode: data.zonecode, addressText: fullAddress };
                                handleUpdateOrderBatch(order.id, updates);
                                showToast('ì£¼ì†Œê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        }).open();
                    } catch (error) { fallbackToNaver(); }
                } else { fallbackToNaver(); }
            };
            const fallbackToNaver = () => {
                showToast('ë„¤ì´ë²„ ê²€ìƒ‰ ì°½ì„ ì—½ë‹ˆë‹¤.', 'error');
                window.open('https://search.naver.com/search.naver?query=%EC%9A%B0%ED%8E%B8%EB%B2%88%ED%98%B8%EA%B2%80%EC%83%89', '_blank');
            }
            const handleParse = () => {
                if (!rawAddressText.trim()) { showToast('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
                const parsed = parseAddressInfo(rawAddressText);
                const updates = {
                    recipientName: parsed.recipientName || order.recipientName,
                    phone: parsed.phone || order.phone,
                    zipCode: parsed.zipCode || order.zipCode,
                    addressText: parsed.addressText || order.addressText,
                    shippingMemo: parsed.shippingMemo || order.shippingMemo,
                };
                handleUpdateOrderBatch(order.id, updates);
                showToast('ë³€í™˜ ì™„ë£Œ! (ê°™ì€ ë‹‰ë„¤ì„ ì¼ê´„ ì ìš©)');
                setRawAddressText('');
            };
            const handleChange = (field, value) => { handleUpdateOrderBatch(order.id, { [field]: value }); };
            const inputClass = "w-full p-2 border border-slate-200 dark:border-dark-border rounded-lg text-sm dark:bg-dark-input dark:text-dark-text focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all";
            return (
                <div className="col-span-full p-4 bg-slate-50/80 dark:bg-dark-card rounded-xl shadow-inner mt-2 mb-2 border border-slate-200 dark:border-dark-border animate-fade-in">
                    <div className="flex justify-between items-center pb-3 border-b border-slate-200 dark:border-dark-border mb-3">
                        <h3 className="text-sm font-bold text-slate-700 dark:text-dark-text flex items-center gap-2"><Icon name="MapPin" size={18} className="text-brand-600"/> ë°°ì†¡ ì •ë³´ í¸ì§‘</h3>
                        <div className="flex gap-2"><ActionButton onClick={handleOpenAddressSearch} color="white" icon="Search" text="ì£¼ì†Œ ê²€ìƒ‰" /><ActionButton onClick={() => setEditingAddressId(null)} color="blue" icon="FloppyDisk" text="ì™„ë£Œ" /></div>
                    </div>
                    <div className="flex gap-2 mb-3">
                        <textarea className="flex-1 p-3 border border-slate-200 dark:border-dark-border rounded-lg text-xs dark:bg-dark-input dark:text-dark-text focus:ring-2 focus:ring-brand-500 resize-none h-14" placeholder="í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° (ì˜ˆ: ê°•ì€ì§€ 010-1234-5678 ì„œìš¸ì‹œ ê°•ë‚¨êµ¬...)" value={rawAddressText} onChange={(e) => setRawAddressText(e.target.value)}/>
                        <button onClick={handleParse} className="w-16 flex-none bg-brand-50 text-brand-600 hover:bg-brand-100 dark:bg-slate-700 dark:text-white rounded-lg text-xs font-bold border border-brand-200 dark:border-slate-600 transition-colors">ìë™<br/>ì…ë ¥</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
                        <div><label className="block text-[10px] font-bold mb-1 text-slate-500 uppercase tracking-wider">ìˆ˜ë ¹ì¸</label><input type="text" value={order.recipientName} onChange={(e) => handleChange('recipientName', e.target.value)} className={inputClass} /></div>
                        <div><label className="block text-[10px] font-bold mb-1 text-slate-500 uppercase tracking-wider">ì—°ë½ì²˜</label><input type="text" value={order.phone} onChange={(e) => handleChange('phone', e.target.value)} className={inputClass} /></div>
                        <div><label className="block text-[10px] font-bold mb-1 text-slate-500 uppercase tracking-wider">ìš°í¸ë²ˆí˜¸</label><input type="text" value={order.zipCode} onChange={(e) => handleChange('zipCode', e.target.value)} className={inputClass} /></div>
                        <div><label className="block text-[10px] font-bold mb-1 text-slate-500 uppercase tracking-wider">ë°°ì†¡ ë©”ëª¨</label><input type="text" value={order.shippingMemo} onChange={(e) => handleChange('shippingMemo', e.target.value)} className={inputClass} /></div>
                    </div>
                    <div><label className="block text-[10px] font-bold mb-1 text-slate-500 uppercase tracking-wider">ì£¼ì†Œ</label><input type="text" value={order.addressText} onChange={(e) => handleChange('addressText', e.target.value)} className={inputClass} /></div>
                </div>
            );
        };

        const ProductAutocomplete = ({ id, value, onChange, onSelect, onDeleteProduct, onKeyDown, priceMap }) => {
            const [showSuggestions, setShowSuggestions] = useState(false);
            const wrapperRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) { setShowSuggestions(false); }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            const filtered = Object.entries(priceMap).filter(([name]) => name.toLowerCase().includes(value.toLowerCase()));
            const handleSelect = (name, price) => { onSelect(name, price); setShowSuggestions(false); };
            const handleDelete = (e, name) => { e.stopPropagation(); onDeleteProduct(name); };
            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <input id={id} className="w-full bg-transparent outline-none text-slate-900 dark:text-dark-text text-sm font-medium tracking-tight font-sans placeholder-slate-400" value={value} onChange={(e) => { onChange(e); setShowSuggestions(true); }} onFocus={() => setShowSuggestions(true)} onKeyDown={onKeyDown} placeholder="ìƒí’ˆëª… ì…ë ¥" autoComplete="off" />
                    {showSuggestions && filtered.length > 0 && (
                        <ul className="absolute z-50 left-0 mt-1 w-full bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-xl max-h-48 overflow-y-auto py-1">
                            {filtered.map(([name, price]) => (
                                <li key={name} className="px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex justify-between items-center text-sm border-b border-slate-50 dark:border-dark-border last:border-0 group transition-colors" onClick={() => handleSelect(name, price)}>
                                    <div className="flex items-center flex-1 min-w-0 gap-2"><span className="font-medium text-slate-700 dark:text-dark-text truncate">{name}</span><span className="text-[10px] text-slate-400 bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded-full">{price.toLocaleString()}</span></div>
                                    <button onClick={(e) => handleDelete(e, name)} className="p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded transition-colors opacity-0 group-hover:opacity-100"><Icon name="Trash2" size={14} /></button>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        const App = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            const [rawInput, setRawInput] = useState('');
            const [globalMemo, setGlobalMemo] = useState(() => localStorage.getItem('globalMemo') || '');
            const [productHistory, setProductHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('productHistory')) || {}; } catch { return {}; } });
            const [orders, setOrders] = useState(() => { try { const stored = JSON.parse(localStorage.getItem('youtubeOrders')); if (Array.isArray(stored)) return stored.map(sanitizeOrder).filter(o => o !== null); return []; } catch { return []; } });
            const [isProcessing, setIsProcessing] = useState(false);
            const [toast, setToast] = useState(null);
            const [pricePerUnit, setPricePerUnit] = useState('');
            const [shippingFee, setShippingFee] = useState(4000);
            const [defaultProductName, setDefaultProductName] = useState('');
            const [filterText, setFilterText] = useState('');
            const [editingAmountId, setEditingAmountId] = useState(null);
            const [editingAddressId, setEditingAddressId] = useState(null); 
            const [editingShippingId, setEditingShippingId] = useState(null); 
            const [unpaidFilter, setUnpaidFilter] = useState(null); 
            const [isProductManagerOpen, setIsProductManagerOpen] = useState(false);
            const [isExcelMenuOpen, setIsExcelMenuOpen] = useState(false);
            
            const ordersRef = useRef(orders);
            const fileInputRef = useRef(null);
            const excelMenuRef = useRef(null); // Ref for dropdown

            useEffect(() => { if (isDarkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }, [isDarkMode]);
            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); ordersRef.current = orders; }, [orders]);
            useEffect(() => { localStorage.setItem('globalMemo', globalMemo); }, [globalMemo]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);

            // Click outside to close Excel menu
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (excelMenuRef.current && !excelMenuRef.current.contains(event.target)) {
                        setIsExcelMenuOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // --- FIX: Using invisible char to force text in Excel (most robust method) ---
            const getCSVString = (listData, mode) => {
                 const list = [...listData].map(sanitizeOrder).sort((a, b) => (a.customer || '').localeCompare(b.customer || ''));
                const firstIds = {};
                list.forEach(o => { if (o.customer && !firstIds[o.customer]) firstIds[o.customer] = o.id; });
                const clean = (val) => `"${String(val || '').replace(/"/g, '""')}"`;
                
                const cleanPhone = (val) => {
                    if (!val) return '""';
                    const strVal = String(val);
                    // Using Zero Width Space to force Excel to treat as text without ugly characters
                    return `"\u200B${strVal}"`; 
                };

                if (mode === 'invoice') {
                    const excelHeaders = ['', '', '', '', 'ìƒí’ˆëª…', 'ìˆ˜ë ¹ì¸', 'ì—°ë½ì²˜', 'ì£¼ì†Œ', 'ë°°ì†¡ë©”ëª¨', '', 'ë©”ëª¨', 'ìš°í¸ë²ˆí˜¸', ''];
                    const csv = [excelHeaders.join(',')].concat(list.map(o => {
                            let quantitySuffix = '';
                            if (o.quantity >= 2) { quantitySuffix = ` â˜…${o.quantity}`; }
                            const productName = `[${o.customer || 'ë¯¸ì§€ì •'}] ${o.product}${quantitySuffix}`;
                            return ['', '', '', '', clean(productName), clean(o.recipientName), cleanPhone(o.phone), clean(o.addressText), clean(o.shippingMemo), '', clean(o.memo), cleanPhone(o.zipCode), ''].join(',');
                        })).join('\n');
                    return "\ufeff" + csv;
                } else {
                    const headers = ['ë‹‰ë„¤ì„', 'ì…ê¸ˆëª…', 'ìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ê¸ˆì•¡', 'ì…ê¸ˆì•¡(í˜„ê¸ˆ)', 'ì¹´ë“œê²°ì œì•¡', 'ë°°ì†¡ë¹„', 'ë¯¸ìˆ˜ê¸ˆ', 'ìˆ˜ë ¹ì¸', 'ì—°ë½ì²˜', 'ìš°í¸ë²ˆí˜¸', 'ì£¼ì†Œ', 'ë°°ì†¡ë©”ëª¨', 'ë©”ëª¨'];
                    const csv = [headers.join(',')].concat(list.map(o => {
                            const isFirst = firstIds[o.customer] === o.id;
                            const ship = o.customShippingFee ?? shippingFee;
                            const shipCharge = isFirst ? ship : 0;
                            const unpaid = Math.max(0, (o.price + shipCharge) - (o.deposit + o.cardAmount + (isFirst && o.isShippingPaid ? ship : 0)));
                            const productName = `${o.product}`; 
                            return [clean(o.customer), clean(o.phone), clean(productName), o.quantity, o.price, clean(o.deposit), clean(o.cardAmount), clean(shipCharge), clean(unpaid), clean(o.recipientName), cleanPhone(o.phone), cleanPhone(o.zipCode), clean(o.addressText), clean(o.shippingMemo), clean(o.memo)].join(',');
                        })).join('\n');
                    return "\ufeff" + csv;
                }
            };

            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 3000); };
            const handleDownloadCSV = (mode = 'invoice') => { if (ordersRef.current.length === 0) return; const csvContent = getCSVString(ordersRef.current, mode); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const typeName = mode === 'invoice' ? 'ì†¡ì¥ìš©' : 'ì „ì²´ë‚´ì—­'; const fileName = `ê°•ì€ì§€_ì£¼ë¬¸ì„œ_${typeName}_${new Date().toLocaleDateString()}.csv`; a.download = fileName; a.click(); URL.revokeObjectURL(url); showToast(`${typeName} ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`); };

            const handleDownloadProductCSV = () => {
                const targetOrders = filteredOrders.length > 0 ? filteredOrders : orders;
                if (targetOrders.length === 0) return;
                const summary = targetOrders.reduce((acc, curr) => {
                    const name = curr.product;
                    if (!acc[name]) acc[name] = 0;
                    acc[name] += curr.quantity;
                    return acc;
                }, {});
                const csv = "\ufeff" + ["ìƒí’ˆëª…,ì´ìˆ˜ëŸ‰"].concat(Object.entries(summary).map(([name, qty]) => `"${name}",${qty}`)).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ê°•ì€ì§€_ì£¼ë¬¸ì„œ_ë°œì£¼ë‚´ì—­_${new Date().toLocaleDateString()}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('ë°œì£¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
            };

            const handleDownloadHTML = () => { const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date(); const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}`; a.download = `ê°•ì€ì§€_ì£¼ë¬¸ì„œ_ë°±ì—…_${timestamp}.html`; a.click(); URL.revokeObjectURL(url); showToast('ì•± íŒŒì¼ì´ ì•ˆì „í•˜ê²Œ ë°±ì—…(ì €ì¥)ë˜ì—ˆìŠµë‹ˆë‹¤!'); };
            const handleUploadClick = () => fileInputRef.current && fileInputRef.current.click();
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const uploaded = results.data.map((row, i) => sanitizeOrder({ id: Date.now() + i, originalText: `UPLOAD: ${row['ìƒí’ˆëª…']}`, customer: row['ë‹‰ë„¤ì„']?.trim(), product: row['ìƒí’ˆëª…'], quantity: Number(row['ìˆ˜ëŸ‰']) || 1, price: Number(row['ê¸ˆì•¡']?.replace(/,/g, '')) || 0, deposit: Number(row['ì…ê¸ˆì•¡(í˜„ê¸ˆ)']), cardAmount: Number(row['ì¹´ë“œê²°ì œì•¡']), recipientName: row['ìˆ˜ë ¹ì¸'], phone: row['ì—°ë½ì²˜'], zipCode: row['ìš°í¸ë²ˆí˜¸'], addressText: row['ì£¼ì†Œ'], shippingMemo: row['ë°°ì†¡ë©”ëª¨'], memo: row['ë©”ëª¨'] })).filter(o => o.customer); setOrders(prev => [...uploaded, ...prev]); showToast(`${uploaded.length}ê±´ ì—…ë¡œë“œ ì™„ë£Œ!`); }}); e.target.value = null; };
            
            // --- NEW: Reset Confirmation ---
            const handleReset = () => {
                if (window.confirm("ì •ë§ë¡œ ëª¨ë“  ì£¼ë¬¸ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                    setOrders([]);
                    showToast("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", "error");
                }
            };

            // --- HELPER FUNCTIONS ---
            const getNicknameColor = (name) => {
                if (!name) return 'text-slate-900 dark:text-dark-text';
                const colors = ['text-red-600 dark:text-red-400', 'text-orange-600 dark:text-orange-400', 'text-amber-600 dark:text-amber-400', 'text-green-600 dark:text-green-400', 'text-emerald-600 dark:text-emerald-400', 'text-teal-600 dark:text-teal-400', 'text-cyan-600 dark:text-cyan-400', 'text-blue-600 dark:text-blue-400', 'text-indigo-600 dark:text-indigo-400', 'text-violet-600 dark:text-violet-400', 'text-purple-600 dark:text-purple-400', 'text-fuchsia-600 dark:text-fuchsia-400', 'text-pink-600 dark:text-pink-400', 'text-rose-600 dark:text-rose-400'];
                let hash = 0;
                for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
                return colors[Math.abs(hash) % colors.length];
            };
            
            const handleCopyMemo = () => {
                if (!globalMemo) { showToast('ë³µì‚¬í•  ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
                const ta = document.createElement("textarea"); ta.value = globalMemo; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                showToast('ë©”ëª¨ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            };

            const handleCopyResults = () => { 
                if (filteredOrders.length === 0) return; 
                let text = ''; 
                const grouped = filteredOrders.reduce((acc, o) => { (acc[o.customer] = acc[o.customer] || []).push(o); return acc; }, {}); 
                Object.entries(grouped).forEach(([name, items]) => { 
                    text += `ğŸ’™ ${name} ë‹˜ ğŸ’™\n\n`; 
                    items.forEach(o => { const qtyText = o.quantity > 1 ? ` (${o.quantity})` : ''; text += `${o.product}${qtyText} ${o.price.toLocaleString()}\n` }); 
                    
                    const shipFee = items[0].customShippingFee ?? shippingFee; 
                    if (shipFee > 0) text += `ë°°ì†¡ë¹„ ${shipFee.toLocaleString()}\n`; 
                    text += `-\n`; 
                    
                    const cardTotal = items.reduce((s, o) => s + o.cardAmount, 0); 
                    const depositTotal = items.reduce((s, o) => s + o.deposit, 0); 
                    const itemTotal = items.reduce((s, o) => s + o.price, 0); 
                    const paidTotal = depositTotal + cardTotal;
                    const totalRequired = itemTotal + shipFee;
                    const isShipPaid = items.some(o => o.isShippingPaid);
                    
                    if (cardTotal > 0) { 
                        const cardFee = Math.round(cardTotal * 0.10); 
                        const totalCardPayment = cardTotal + cardFee; 
                        text += `ì…ê¸ˆ ${depositTotal.toLocaleString()}\n`; 
                        text += `ì¹´ë“œ ${cardTotal.toLocaleString()}\n`; 
                        text += `ì´ ì¹´ë“œê²°ì œ (10%) \n${totalCardPayment.toLocaleString()} ì˜ˆì •\n`; 
                    } else if (depositTotal > 0) { 
                        const displayDepositTotal = isShipPaid ? (depositTotal + shipFee) : depositTotal;
                        text += `ì…ê¸ˆ ${displayDepositTotal.toLocaleString()}\n`; 
                    } 
                    text += `Â -\n`; 
                    
                    const shippingCredit = isShipPaid ? shipFee : 0;
                    const totalUnpaid = Math.max(0, totalRequired - paidTotal - shippingCredit);
                    
                    if (totalUnpaid > 0) { 
                        text += `ë¯¸ì…ê¸ˆ: ${totalUnpaid.toLocaleString()}ì›\n\n`; 
                    } else { 
                        text += `ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜\n\n`; 
                    } 
                }); 
                const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('ì£¼ë¬¸ ë‚´ì—­ ë³µì‚¬ ì™„ë£Œ!'); 
            };

            const firstOrderIds = useMemo(() => { const ids = {}; orders.forEach(o => { if (o.customer && !ids[o.customer]) ids[o.customer] = o.id; }); return ids; }, [orders]);
            const customerCounts = useMemo(() => orders.reduce((acc, o) => { if(o.customer) acc[o.customer] = (acc[o.customer] || 0) + 1; return acc; }, {}), [orders]);
            const filteredOrders = useMemo(() => { 
                let result = orders;
                if (filterText) {
                    const lower = filterText.toLowerCase(); 
                    result = result.filter(o => (o.customer && o.customer.toLowerCase().includes(lower)) || (o.product && o.product.toLowerCase().includes(lower))); 
                }

                if (unpaidFilter) {
                    const grouped = orders.reduce((acc, o) => { 
                        const k = o.customer || 'u'; 
                        if(!acc[k]) acc[k] = {p:0, d:0, c:0, ship:false, fee:null}; 
                        acc[k].p += o.price; 
                        acc[k].d += o.deposit; 
                        acc[k].c += o.cardAmount; 
                        if(o.isShippingPaid) acc[k].ship = true; 
                        if(o.customShippingFee !== null) acc[k].fee = o.customShippingFee; 
                        return acc; 
                    }, {});

                    result = result.filter(o => {
                        const g = grouped[o.customer || 'u'];
                        if (!g) return false;
                        const ship = g.fee ?? shippingFee;
                        const totalRequired = g.p + ship;
                        const totalPaid = g.d + g.c;
                        const shippingCredit = g.ship ? ship : 0;
                        const personUnpaid = Math.max(0, totalRequired - totalPaid - shippingCredit);

                        if (unpaidFilter === 'ship') {
                            return !g.ship && ship > 0;
                        } 
                        if (unpaidFilter === 'cash') {
                            let cashUnpaid = 0;
                             if (g.ship) {
                                cashUnpaid = personUnpaid;
                            } else {
                                const unpaidAttribToShip = Math.min(personUnpaid, ship);
                                cashUnpaid = personUnpaid - unpaidAttribToShip;
                            }
                            return cashUnpaid > 0;
                        }
                        return true;
                    });
                }
                return result;
            }, [orders, filterText, unpaidFilter, shippingFee]);

            const stats = useMemo(() => {
                const res = { 
                    qty: 0, orderCount: 0, shippingCount: 0,
                    cardRev: 0, cashRev: 0, shipRev: 0, totalRev: 0,
                    cardUnpaid: 0, cashUnpaid: 0, shipUnpaid: 0,
                    totalUnpaid: 0
                };
                
                const grouped = filteredOrders.reduce((acc, o) => { 
                    const k = o.customer || 'u'; 
                    if(!acc[k]) acc[k] = {p:0, d:0, c:0, ship:false, fee:null, q:0}; 
                    acc[k].p += o.price; 
                    acc[k].d += o.deposit; 
                    acc[k].c += o.cardAmount; 
                    acc[k].q += o.quantity; 
                    if(o.isShippingPaid) acc[k].ship = true; 
                    if(o.customShippingFee !== null) acc[k].fee = o.customShippingFee; 
                    return acc; 
                }, {});

                Object.values(grouped).forEach(g => {
                    const ship = g.fee ?? shippingFee; 
                    res.orderCount++; 
                    res.shippingCount++; 
                    
                    res.cardRev += g.c; 
                    res.cashRev += Math.max(0, g.p - g.c); 
                    res.shipRev += ship;
                    res.totalRev += (g.p + ship);

                    res.qty += g.q; 
                    
                    const totalRequired = g.p + ship;
                    const totalPaid = g.d + g.c;
                    const shippingCredit = g.ship ? ship : 0;
                    
                    const personUnpaid = Math.max(0, totalRequired - totalPaid - shippingCredit);
                    
                    if (g.ship) {
                        res.cashUnpaid += personUnpaid; 
                    } else {
                        const unpaidAttribToShip = Math.min(personUnpaid, ship);
                        res.shipUnpaid += unpaidAttribToShip;
                        res.cashUnpaid += (personUnpaid - unpaidAttribToShip);
                    }

                    res.totalUnpaid += personUnpaid;
                });

                return res;
            }, [filteredOrders, shippingFee]);
            
            const filteredStats = useMemo(() => { return stats; }, [stats]);

            const handleToggleAmountEdit = (id) => { setEditingAmountId(id === editingAmountId ? null : id); setEditingShippingId(null); };
            const handleToggleShippingEdit = (id) => { setEditingShippingId(id === editingShippingId ? null : id); setEditingAmountId(null); };
            const handleToggleAddressEdit = (id) => { setEditingAddressId(id === editingAddressId ? null : id); };
            const handleKeyDown = (e, index, field) => { if (e.key === 'Enter') { e.preventDefault(); const nextIndex = index + 1; if (nextIndex < filteredOrders.length) { const nextElement = document.getElementById(`${field}-${nextIndex}`); if (nextElement) { nextElement.focus(); if (nextElement.select) nextElement.select(); } } } };
            const handleMemoKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); const textarea = e.target; const start = textarea.selectionStart; const end = textarea.selectionEnd; const value = globalMemo; const newValue = value.substring(0, start) + "\nâ–« " + value.substring(end); setGlobalMemo(newValue); setTimeout(() => { textarea.selectionStart = textarea.selectionEnd = start + 3; }, 0); } };
            const handleParseOrders = () => {
                if (!rawInput.trim()) { showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
                setIsProcessing(true);
                setTimeout(() => {
                    const blocks = rawInput.split(/\n\s*\n/).filter(block => block.trim() !== '');
                    const newOrders = blocks.map((block, i) => {
                        const lines = block.trim().split('\n').map(l => l.trim()).filter(l => l);
                        if (lines.length === 0) return null;
                        let rawCustomer = lines[0].replace(/@/g, '').trim();
                        let customer = rawCustomer.replace(/-[a-zA-Z0-9]+$/, '').trim();
                        let product = lines.slice(1).join(' ').trim() || defaultProductName;
                        let quantity = 1; 
                        let unitPrice = productHistory[product] || Number(pricePerUnit) || 0;
                        const price = quantity * unitPrice;
                        const existingOrder = orders.find(o => o.customer === customer);
                        let recipientName = '', zipCode = '', addressText = '', shippingMemo = '', phone = '';
                        if (existingOrder) { recipientName = existingOrder.recipientName; phone = existingOrder.phone; zipCode = existingOrder.zipCode; addressText = existingOrder.addressText; shippingMemo = existingOrder.shippingMemo; }
                        return sanitizeOrder({ id: Date.now() + i + Math.random(), originalText: block, customer, product, quantity, price, phone, deposit: 0, isPaid: false, isShippingPaid: false, isCardPaid: false, cardAmount: 0, customShippingFee: null, memo: '', recipientName, zipCode, addressText, shippingMemo });
                    }).filter(o => o !== null);
                    setOrders(prev => [...newOrders, ...prev]); setRawInput(''); setIsProcessing(false); showToast(`${newOrders.length}ê±´ ì¶”ê°€ ì™„ë£Œ!`);
                }, 100);
            };
            const handleAddEmptyOrder = () => { setOrders(prev => [sanitizeOrder({ id: Date.now(), customer: '', product: defaultProductName, quantity: 1, price: Number(pricePerUnit) || 0 }), ...prev]); };
            const handleUpdateOrder = (id, field, value) => {
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    let updates = { [field]: value };
                    if (field === 'quantity') { const savedUnitPrice = productHistory[o.product] || Number(pricePerUnit) || 0; updates.price = value * savedUnitPrice; }
                    if (field === 'product') { const savedUnitPrice = productHistory[value]; if (savedUnitPrice !== undefined) { updates.price = o.quantity * savedUnitPrice; } }
                    if (field === 'price') { if (o.product && o.quantity > 0) { const unitPrice = value / o.quantity; setProductHistory(prevHist => ({ ...prevHist, [o.product]: unitPrice })); } }
                    const newPrice = updates.price ?? o.price;
                    if (field === 'deposit') { const rem = Math.max(0, newPrice - value); updates.cardAmount = rem; updates.isCardPaid = rem > 0; }
                    return sanitizeOrder({ ...o, ...updates });
                }));
            };
            const handleProductSelect = (id, product, unitPrice) => { setOrders(prev => prev.map(o => { if (o.id !== id) return o; return sanitizeOrder({ ...o, product: product, price: o.quantity * unitPrice }); })); };
            const handleDeleteProduct = useCallback((productName) => { if (window.confirm(`'${productName}' ìƒí’ˆì„ ìë™ì™„ì„± ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { setProductHistory(prev => { const newHistory = { ...prev }; delete newHistory[productName]; return newHistory; }); showToast(`'${productName}' ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`); } }, []);
            const handleUpdateOrderBatch = (id, updates) => { setOrders(prev => { const targetOrder = prev.find(o => o.id === id); if (!targetOrder || !targetOrder.customer) return prev; const isAddressUpdate = ['recipientName', 'phone', 'zipCode', 'addressText', 'shippingMemo'].some(key => key in updates); const targetCustomer = targetOrder.customer.trim(); return prev.map(o => { if (o.id === id) return sanitizeOrder({ ...o, ...updates }); if (isAddressUpdate && o.customer && o.customer.trim() === targetCustomer) return sanitizeOrder({ ...o, ...updates }); return o; }); }); };
            const handleDelete = (id) => setOrders(prev => prev.filter(o => o.id !== id));
            
            const handleAutoDepositFull = (id) => { 
                setOrders(prev => {
                    return prev.map(o => {
                        if (o.id === id) {
                            if (o.isPaid) {
                                return sanitizeOrder({ ...o, deposit: 0, cardAmount: 0, isPaid: false, isCardPaid: false });
                            } else {
                                return sanitizeOrder({ ...o, deposit: o.price, cardAmount: 0, isPaid: true, isCardPaid: false });
                            }
                        }
                        return o;
                    });
                }); 
                setEditingAmountId(null); 
                setEditingShippingId(null);
            };
            
            const handleAutoCardFull = (id) => { setOrders(prev => prev.map(o => o.id === id ? sanitizeOrder({ ...o, deposit: 0, cardAmount: o.price, isPaid: true, isCardPaid: true }) : o)); setEditingAmountId(null); setEditingShippingId(null); };

            const handleUnpaidFilterClick = (type) => {
                if (unpaidFilter === type) {
                    setUnpaidFilter(null); 
                } else {
                    setUnpaidFilter(type); 
                }
            };

            return (
                <div className="min-h-screen flex flex-col text-slate-900 dark:text-dark-text">
                    <header className="sticky top-0 z-50 bg-white/80 dark:bg-dark-card/80 backdrop-blur-md border-b border-slate-200 dark:border-dark-border flex-none">
                        <div className="max-w-[1920px] mx-auto px-6 h-16 flex items-center justify-between gap-6">
                            <div className="flex items-center gap-3 text-indigo-600 dark:text-indigo-400 min-w-fit">
                                <Icon name="Package" size={28} />
                                <h1 className="text-xl font-bold text-slate-900 dark:text-dark-text hidden md:block">ê°•ì€ì§€ ì£¼ë¬¸ì„œ ìë™í™” v1.2 (Final)</h1>
                            </div>
                            <div className="flex items-center gap-3 text-sm whitespace-nowrap">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-yellow-500"><Icon name="Moon" size={20} /></button>
                                
                                {/* Product Manager Button */}
                                <button onClick={() => setIsProductManagerOpen(true)} className="px-3 py-1 bg-brand-500 hover:bg-brand-600 text-white rounded transition-colors">ìƒí’ˆ ê´€ë¦¬</button>
                                
                                {/* Reset Button with Confirm */}
                                <button onClick={handleReset} className="px-3 py-1 bg-slate-500 hover:bg-slate-600 text-white rounded transition-colors">ì´ˆê¸°í™”</button>
                                
                                {/* Combined Excel Button */}
                                <div className="relative" ref={excelMenuRef}>
                                    <button 
                                        onClick={() => setIsExcelMenuOpen(!isExcelMenuOpen)}
                                        className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded transition-colors flex items-center gap-1"
                                    >
                                        ì—‘ì…€ ì €ì¥ <Icon name="CaretDown" size={12} />
                                    </button>
                                    {isExcelMenuOpen && (
                                        <div className="absolute top-full right-0 mt-1 w-40 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-xl z-50 overflow-hidden">
                                            <button onClick={() => { handleDownloadCSV('full'); setIsExcelMenuOpen(false); }} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 border-b border-slate-100 dark:border-slate-700 flex items-center gap-2"><Icon name="FileXls" size={14}/> ì „ì²´ ë‚´ì—­</button>
                                            <button onClick={() => { handleDownloadCSV('invoice'); setIsExcelMenuOpen(false); }} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 border-b border-slate-100 dark:border-slate-700 flex items-center gap-2"><Icon name="Truck" size={14}/> ì†¡ì¥ìš©</button>
                                            <button onClick={() => { handleDownloadProductCSV(); setIsExcelMenuOpen(false); }} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 flex items-center gap-2"><Icon name="List" size={14}/> ë°œì£¼ìš© (í†µê³„)</button>
                                        </div>
                                    )}
                                </div>

                                <button onClick={handleDownloadHTML} className="px-3 py-1 bg-indigo-600 text-white rounded">ì•± ë°±ì—…(ì €ì¥)</button>
                                <button onClick={handleUploadClick} className="px-3 py-1 bg-slate-600 text-white rounded">ì—…ë¡œë“œ</button>
                                <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-[1920px] mx-auto w-full px-6 py-6 flex flex-col gap-4">
                        <datalist id="product-options">
                            {Object.entries(productHistory).map(([product, price]) => (
                                <option key={product} value={product} label={`${price.toLocaleString()}ì›`} />
                            ))}
                        </datalist>

                        <div className="flex-none grid grid-cols-1 gap-3">
                            <SummaryDashboardCard 
                                totalRevenue={stats.totalRev}
                                orderCount={stats.qty} 
                                shippingCount={stats.shippingCount}
                            />
                            
                            <div className="grid grid-cols-3 gap-3">
                                <DashboardCard icon="CreditCard" color="pink" title="ì¹´ë“œë§¤ì¶œ" value={stats.cardRev} />
                                <DashboardCard icon="Bank" color="emerald" title="í˜„ê¸ˆë§¤ì¶œ" value={stats.cashRev} />
                                <DashboardCard icon="Truck" color="cyan" title="ë°°ì†¡ë¹„ë§¤ì¶œ" value={stats.shipRev} />
                            </div>

                            <div className="grid grid-cols-3 gap-3">
                                <DashboardCard icon="Calculator" color="red" title="ì´ ë¯¸ìˆ˜ê¸ˆ í•©ê³„" value={stats.totalUnpaid} isUnpaid={true} />
                                <DashboardCard 
                                    icon="HandCoins" 
                                    color="orange" 
                                    title="í˜„ê¸ˆ ë¯¸ìˆ˜ê¸ˆ" 
                                    value={stats.cashUnpaid} 
                                    isUnpaid={true} 
                                    onClick={() => handleUnpaidFilterClick('cash')}
                                    isActive={unpaidFilter === 'cash'}
                                />
                                <DashboardCard 
                                    icon="Truck" 
                                    color="amber" 
                                    title="ë°°ì†¡ ë¯¸ìˆ˜ê¸ˆ" 
                                    value={stats.shipUnpaid} 
                                    isUnpaid={true} 
                                    onClick={() => handleUnpaidFilterClick('ship')}
                                    isActive={unpaidFilter === 'ship'}
                                />
                            </div>
                        </div>

                        <div className="flex flex-col gap-4">
                            {/* ... Paste & Memo sections ... */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 flex-none h-48 md:h-56">
                                <div className="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-slate-200 dark:border-dark-border p-4 flex flex-col h-full">
                                    <div className="flex items-center justify-between mb-2 h-8">
                                        <h2 className="text-sm font-bold flex items-center gap-2 text-slate-900 dark:text-dark-text">
                                            <div className="w-1 h-4 bg-indigo-500 rounded-full"></div>ëŒ“ê¸€ ë¶™ì—¬ë„£ê¸°
                                        </h2>
                                    </div>
                                    <textarea 
                                        className="flex-1 w-full p-3 border border-slate-300 dark:border-dark-border rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none text-sm dark:bg-dark-input dark:text-dark-text mb-3 leading-relaxed" 
                                        placeholder="ì˜ˆ: @ê¹€ì² ìˆ˜ \n Aì„¸íŠ¸ 2ê°œ \n\n @ì˜í¬ \n Bì„¸íŠ¸ 1ê°œ" 
                                        value={rawInput} 
                                        onChange={(e) => setRawInput(e.target.value)}
                                    ></textarea>
                                    <button onClick={handleParseOrders} disabled={isProcessing} className="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm transition-colors flex justify-center items-center gap-2">
                                        {isProcessing ? 'ë³€í™˜ ì¤‘...' : 'ì£¼ë¬¸ì„œ ë³€í™˜'} <Icon name="ArrowRight" size={16}/>
                                    </button>
                                </div>

                                <div className="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-slate-200 dark:border-dark-border p-4 flex flex-col h-full relative">
                                    <div className="flex justify-between items-center mb-2 h-8">
                                        <h2 className="text-sm font-bold flex items-center gap-2 text-slate-900 dark:text-dark-text">
                                            <div className="w-1 h-4 bg-yellow-500 rounded-full"></div>ë©”ëª¨ì¥
                                        </h2>
                                        <button onClick={handleCopyMemo} className="p-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors" title="ë©”ëª¨ ë³µì‚¬">
                                            <Icon name="Copy" size={18}/>
                                        </button>
                                    </div>
                                    <textarea 
                                        className="flex-1 w-full p-3 border border-slate-300 dark:border-dark-border rounded-lg focus:ring-2 focus:ring-yellow-500 resize-none text-sm dark:bg-dark-input dark:text-dark-text leading-relaxed" 
                                        placeholder="ììœ ë¡­ê²Œ ë©”ëª¨í•˜ì„¸ìš”... (ì—”í„° í‚¤ë¡œ ì¤„ êµ¬ë¶„)"
                                        value={globalMemo}
                                        onChange={(e) => setGlobalMemo(e.target.value)}
                                        onKeyDown={handleMemoKeyDown}
                                    ></textarea>
                                </div>
                            </div>

                            {/* Main Order List Section */}
                            <div className="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-slate-200 dark:border-dark-border flex flex-col">
                                {/* ... Search & Add Controls ... */}
                                <div className="p-3 border-b border-slate-100 dark:border-dark-border flex flex-nowrap gap-2 items-center justify-between bg-slate-50/50 dark:bg-dark-card overflow-x-auto">
                                    <div className="flex items-center gap-2 w-40 flex-none">
                                        <div className="relative flex-1">
                                            <div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={14} /></div>
                                            <input className="w-full pl-7 pr-2 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 dark:bg-dark-input dark:border-dark-border dark:text-dark-text" 
                                                placeholder="ê²€ìƒ‰" value={filterText} onChange={(e) => setFilterText(e.target.value)} />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2 text-xs flex-none">
                                        <div className="flex items-center bg-white dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1.5">
                                            <span className="text-slate-500 dark:text-dark-muted mr-2">ìƒí’ˆ:</span>
                                            <input type="text" value={defaultProductName} onChange={(e) => setDefaultProductName(e.target.value)} className="w-32 bg-transparent outline-none font-bold text-slate-700 dark:text-dark-text text-sm" placeholder="ê¸°ë³¸" />
                                        </div>
                                        <div className="flex items-center bg-white dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1.5">
                                            <span className="text-slate-500 dark:text-dark-muted mr-2">ë‹¨ê°€:</span>
                                            <input type="number" value={pricePerUnit} onChange={(e) => setPricePerUnit(e.target.value)} className="w-20 bg-transparent outline-none font-bold text-right text-slate-700 dark:text-dark-text text-sm" placeholder="0" />
                                        </div>
                                        <div className="flex items-center bg-white dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1.5">
                                            <span className="text-slate-500 dark:text-dark-muted mr-2">ë°°ì†¡:</span>
                                            <input type="number" value={shippingFee} onChange={(e) => setShippingFee(Number(e.target.value))} className="w-20 bg-transparent outline-none font-bold text-right text-slate-700 dark:text-dark-text text-sm" />
                                        </div>
                                        <ActionButton onClick={handleAddEmptyOrder} color="blue" icon="Plus" text="ì¶”ê°€" />
                                    </div>
                                    <div className="flex items-center gap-2 flex-none">
                                        <ActionButton onClick={handleCopyResults} color="slate" icon="Copy" text="ë³µì‚¬" />
                                    </div>
                                </div>

                                {/* Table Header */}
                                <div className="sticky top-16 z-40 grid grid-cols-[0.5fr_2.0fr_4.0fr_0.4fr_1.0fr_1.5fr_2.0fr_0.5fr] gap-4 p-3 bg-slate-100 dark:bg-dark-input text-xs font-bold text-slate-500 dark:text-dark-muted border-b dark:border-dark-border text-center shadow-sm">
                                    <div className="text-center">ì£¼ì†Œ</div><div className="text-left">ë‹‰ë„¤ì„/ì…ê¸ˆëª…</div><div className="text-left">ìƒí’ˆëª…</div><div className="text-center">ìˆ˜ëŸ‰</div><div class="text-right">ê¸ˆì•¡</div><div class="text-center">ìƒíƒœ</div><div class="text-center">ë©”ëª¨</div><div class="text-center">ì‚­ì œ</div>
                                </div>

                                {/* List */}
                                <div className="p-2 space-y-2">
                                    {filteredOrders.length === 0 ? (
                                        <div className="p-8 text-center text-slate-500 dark:text-dark-muted">
                                            {unpaidFilter ? (unpaidFilter === 'cash' ? 'í˜„ê¸ˆ ë¯¸ìˆ˜ê¸ˆì´ ìˆëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ë°°ì†¡ ë¯¸ìˆ˜ê¸ˆì´ ìˆëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.') : 'ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.'}
                                        </div>
                                    ) : (
                                        filteredOrders.map((order, index) => {
                                            const isFirst = firstOrderIds[order.customer] === order.id;
                                            const addressIconClass = order.isAddressFilled ? 'bg-slate-900 text-white dark:bg-slate-200 dark:text-slate-900' : 'bg-slate-50 text-slate-300 hover:bg-slate-100 dark:bg-dark-input dark:text-slate-600 dark:hover:bg-slate-700';
                                            const nickColor = getNicknameColor(order.customer);
                                            let moneyIcon = order.deposit > 0 ? (order.cardAmount > 0 ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600') : 'bg-slate-50 text-slate-300 dark:bg-dark-input dark:text-slate-600';
                                            let cardIcon = order.cardAmount > 0 ? 'bg-pink-100 text-pink-500' : 'bg-slate-50 text-slate-300 dark:bg-dark-input dark:text-slate-600';
                                            const currentShippingFee = order.customShippingFee ?? shippingFee;
                                            const isFreeShipping = currentShippingFee === 0;
                                            let shippingIconClass = order.isShippingPaid 
                                                ? 'bg-blue-100 text-blue-600' 
                                                : (isFreeShipping ? 'bg-slate-100 text-slate-400' : 'bg-slate-50 text-slate-300 dark:bg-dark-input dark:text-slate-600');

                                            return (
                                                <React.Fragment key={order.id}>
                                                    <div className={`grid grid-cols-[0.5fr_2.0fr_4.0fr_0.4fr_1.0fr_1.5fr_2.0fr_0.5fr] gap-4 p-3 border rounded-lg items-center text-sm transition-colors ${order.price > 0 && (order.deposit + order.cardAmount < order.price) ? 'bg-red-50 border-red-100 dark:bg-red-900/20 dark:border-red-900' : 'bg-white border-slate-100 dark:bg-dark-card dark:border-dark-border'}`}>
                                                        <div className="flex justify-center"><button onClick={() => handleToggleAddressEdit(order.id)} className={`w-9 h-9 rounded-full flex items-center justify-center transition-all ${addressIconClass}`}><Icon name="MapPin" size={20}/></button></div>
                                                        <div className="relative pl-1">
                                                            <input id={`customer-${index}`} onKeyDown={e => handleKeyDown(e, index, 'customer')} className={`w-full bg-transparent font-bold outline-none text-base ${nickColor}`} value={order.customer} onChange={e => handleUpdateOrder(order.id, 'customer', e.target.value)} placeholder="ë‹‰ë„¤ì„" />
                                                            <input id={`phone-${index}`} onKeyDown={e => handleKeyDown(e, index, 'phone')} className="w-full bg-transparent text-slate-400 dark:text-slate-500 text-xs outline-none block mt-0.5" value={order.phone} onChange={e => handleUpdateOrder(order.id, 'phone', e.target.value)} placeholder="ì…ê¸ˆëª…" />
                                                            {customerCounts[order.customer] > 1 && <span className="absolute right-0 top-0 text-[10px] bg-slate-200 dark:bg-slate-600 px-1.5 rounded-full text-slate-600 dark:text-slate-300 font-bold">{customerCounts[order.customer]}</span>}
                                                        </div>
                                                        <div><ProductAutocomplete id={`product-${index}`} value={order.product} onChange={(e) => handleUpdateOrder(order.id, 'product', e.target.value)} onSelect={(name, price) => handleProductSelect(order.id, name, price)} onDeleteProduct={handleDeleteProduct} onKeyDown={(e) => handleKeyDown(e, index, 'product')} priceMap={productHistory} /></div>
                                                        <div className="flex justify-center"><input id={`quantity-${index}`} onKeyDown={e => handleKeyDown(e, index, 'quantity')} type="number" className="w-full text-center bg-slate-50 dark:bg-dark-input rounded font-bold dark:text-dark-text" value={order.quantity} onChange={e => handleUpdateOrder(order.id, 'quantity', Number(e.target.value))} /></div>
                                                        <div className="text-right"><input id={`price-${index}`} onKeyDown={e => handleKeyDown(e, index, 'price')} className="w-full text-right bg-transparent font-bold dark:text-dark-text" value={order.price === 0 ? '' : order.price.toLocaleString()} onChange={e => { const v = e.target.value.replace(/,/g,''); if(!isNaN(v)) handleUpdateOrder(order.id, 'price', Number(v)); }} placeholder="0" /></div>
                                                        <div className="flex justify-center gap-1">
                                                            <button onClick={() => handleAutoDepositFull(order.id)} className={`w-9 h-9 rounded-full flex justify-center items-center transition-all ${moneyIcon}`}><Icon name="DollarSign" size={27}/></button>
                                                            {isFirst ? (
                                                                <div className="relative group">
                                                                    <button onClick={() => handleUpdateOrder(order.id, 'isShippingPaid', !order.isShippingPaid)} onContextMenu={(e) => { e.preventDefault(); handleToggleShippingEdit(order.id); }} className={`w-9 h-9 rounded-full flex justify-center items-center transition-all ${shippingIconClass}`} title="í´ë¦­: ë°°ì†¡ë¹„ ë‚©ë¶€ í† ê¸€ / ìš°í´ë¦­: ë°°ì†¡ë¹„ ê¸ˆì•¡ ìˆ˜ì •"><Icon name="Truck" size={27}/></button>
                                                                    {currentShippingFee !== shippingFee && (<span className="absolute -top-1 -right-1 bg-slate-500 text-white text-[9px] px-1 rounded-full">{currentShippingFee/1000}k</span>)}
                                                                </div>
                                                            ) : <div className="w-9"/>}
                                                            <button onClick={() => handleToggleAmountEdit(order.id)} className={`w-9 h-9 rounded-full flex justify-center items-center transition-all ${cardIcon}`}><Icon name="CreditCard" size={27}/></button>
                                                        </div>
                                                        <div><input id={`memo-${index}`} onKeyDown={e => handleKeyDown(e, index, 'memo')} className="w-full text-center bg-transparent outline-none dark:text-dark-text" value={order.memo} onChange={e => handleUpdateOrder(order.id, 'memo', e.target.value)} placeholder="ë©”ëª¨" /></div>
                                                        <div className="flex justify-center"><button onClick={() => handleDelete(order.id)} className="text-slate-300 hover:text-red-500 dark:text-slate-600"><Icon name="Trash2" size={18}/></button></div>
                                                    </div>
                                                    {editingAmountId === order.id && ( <div className="col-span-full p-2 bg-slate-100 dark:bg-dark-input rounded flex gap-2 justify-end items-center"> <button onClick={() => handleAutoCardFull(order.id)} className="w-8 h-8 rounded-md flex items-center justify-center bg-pink-100 text-pink-600 hover:bg-pink-200 transition-colors" title="ì¹´ë“œ ì „ì•¡ ê²°ì œ"><Icon name="CreditCard" size={20}/></button> <span className="text-xs font-bold dark:text-dark-text">í˜„ê¸ˆ:</span><input type="number" className="w-24 p-1 rounded border dark:bg-dark-card dark:border-dark-border dark:text-white" value={order.deposit} onChange={e => handleUpdateOrder(order.id, 'deposit', Number(e.target.value))} /> <span className="text-xs font-bold dark:text-dark-text">ì¹´ë“œ:</span><input type="number" className="w-24 p-1 rounded border dark:bg-dark-card dark:border-dark-border dark:text-white" value={order.cardAmount} onChange={e => handleUpdateOrder(order.id, 'cardAmount', Number(e.target.value))} /> </div> )}
                                                    {editingShippingId === order.id && ( <div className="col-span-full p-2 bg-blue-50 dark:bg-slate-700 rounded flex gap-2 justify-center items-center animate-bounce-in"> <span className="text-xs font-bold text-slate-600 dark:text-slate-300">ê°œë³„ ë°°ì†¡ë¹„ ì„¤ì •:</span> <input type="number" className="w-24 p-1 rounded border border-blue-200 dark:border-slate-500 dark:bg-slate-600 dark:text-white text-center font-bold" value={order.customShippingFee ?? shippingFee} onChange={e => handleUpdateOrder(order.id, 'customShippingFee', Number(e.target.value))} /> <button onClick={() => handleUpdateOrder(order.id, 'customShippingFee', null)} className="text-xs bg-slate-200 px-2 py-1 rounded hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500">ê¸°ë³¸ê°’ ë³µì›</button> <button onClick={() => setEditingShippingId(null)} className="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 ml-2">ë‹«ê¸°</button> </div> )}
                                                    {editingAddressId === order.id && <AddressEditor order={order} handleUpdateOrder={handleUpdateOrder} handleUpdateOrderBatch={handleUpdateOrderBatch} setEditingAddressId={setEditingAddressId} showToast={showToast} />}
                                                </React.Fragment>
                                            );
                                        })
                                    )}
                                </div>
                                {/* Footer */}
                                <div className="p-4 bg-slate-50 dark:bg-dark-input border-t border-slate-200 dark:border-dark-border text-sm flex justify-between items-center rounded-b-xl">
                                    <div className="text-xs text-slate-500 dark:text-dark-muted">ì´ {filteredStats.shippingCount}ëª… ë°°ì†¡ ì˜ˆì •</div>
                                    <div className="text-right flex gap-4">
                                        <div className="font-bold dark:text-dark-text">í•©ê³„ <span className="text-indigo-600 dark:text-indigo-400">{(filteredStats.totalRev).toLocaleString()}ì›</span></div>
                                        {filteredStats.totalUnpaid > 0 && <div className="font-bold text-red-500 dark:text-red-400">ë¯¸ì…ê¸ˆ: {(filteredStats.totalUnpaid).toLocaleString()}ì›</div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    <ProductManager 
                        isOpen={isProductManagerOpen} 
                        onClose={() => setIsProductManagerOpen(false)} 
                        productHistory={productHistory} 
                        setProductHistory={setProductHistory} 
                    />
                    {toast && <div className="fixed bottom-6 right-6 px-4 py-3 bg-slate-800 text-white rounded-xl shadow-xl flex items-center gap-2 animate-bounce-in z-50"><Icon name={toast.type==='error'?'X':'CheckCircle'} className={toast.type==='error'?'text-red-400':'text-green-400'}/> {toast.message}</div>}
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body></html>
